@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject UserPreferencesApiClient UserPreferencesApi
@inject NavigationManager Navigation
@inject LocalizationService LocalizationService
@inject ILogger<LanguageSelector> Logger
@implements IAsyncDisposable

<div class="dropdown">
    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Select language">
        <span class="bi bi-translate" aria-hidden="true"></span>
        <span class="ms-1">@GetLanguageDisplayName(currentLanguage)</span>
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
        <li>
            <button class="dropdown-item @(currentLanguage == "en" ? "active" : "")" @onclick='() => ChangeLanguage("en")'>
                <span class="bi bi-check me-2 @(currentLanguage == "en" ? "" : "invisible")" aria-hidden="true"></span>
                English
            </button>
        </li>
        <li>
            <button class="dropdown-item @(currentLanguage == "ja" ? "active" : "")" @onclick='() => ChangeLanguage("ja")'>
                <span class="bi bi-check me-2 @(currentLanguage == "ja" ? "" : "invisible")" aria-hidden="true"></span>
                日本語 (Japanese)
            </button>
        </li>
    </ul>
</div>

@code {
    private string currentLanguage = "en";
    private IJSObjectReference? languageModule;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Import the language module
                languageModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/languageModule.js");
                
                // Get current language from localStorage or browser
                currentLanguage = await languageModule.InvokeAsync<string>("getLanguage");
                
                // Update LocalizationService with the current language
                LocalizationService.SetCulture(currentLanguage);
                
                // Try to sync with database
                await SyncLanguageFromDatabase();
                
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing language");
                currentLanguage = "en";
                LocalizationService.SetCulture("en");
            }
        }
    }

    private async Task SyncLanguageFromDatabase()
    {
        try
        {
            // Get username from Environment
            // Note: In production with Windows Auth, this should come from authenticated user context
            // For local development without auth, this returns the web app process identity
            var username = Environment.UserName;
            
            // Skip database sync if we don't have a valid username
            if (string.IsNullOrWhiteSpace(username))
            {
                Logger.LogWarning("Cannot sync language from database: no valid username");
                return;
            }
            
            var preferences = await UserPreferencesApi.GetUserPreferencesAsync(username);
            
            if (preferences?.PreferredLanguage != null && preferences.PreferredLanguage != currentLanguage)
            {
                // Use database preference if different from localStorage
                currentLanguage = preferences.PreferredLanguage;
                LocalizationService.SetCulture(currentLanguage);
                if (languageModule != null)
                {
                    await languageModule.InvokeVoidAsync("setLanguage", currentLanguage);
                }
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error syncing language from database");
            // Continue with localStorage value - don't break the UI
        }
    }

    private async Task ChangeLanguage(string language)
    {
        try
        {
            currentLanguage = language;
            
            // Save to localStorage immediately
            if (languageModule != null)
            {
                await languageModule.InvokeVoidAsync("setLanguage", language);
            }
            
            // Update LocalizationService (this will trigger OnLanguageChanged event)
            LocalizationService.SetCulture(language);
            
            // Save to database for cross-device persistence (if we have a valid username)
            var username = Environment.UserName;
            if (!string.IsNullOrWhiteSpace(username))
            {
                await UserPreferencesApi.UpdateUserPreferencesAsync(username, new UserPreferenceDto(language));
            }
            
            // Trigger local UI update
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error changing language");
        }
    }

    private string GetLanguageDisplayName(string langCode)
    {
        return langCode switch
        {
            "ja" => "日本語",
            _ => "EN"
        };
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (languageModule is not null)
        {
            try
            {
                await languageModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // The circuit is already disconnected - this is expected when the browser closes or navigates away
                // Silently ignore as the JavaScript resources are already cleaned up by the browser
            }
        }
    }
}
