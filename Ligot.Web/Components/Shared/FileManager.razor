@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@inject EntityFilesApiClient FilesApi
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="file-manager">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-file-earmark-arrow-up"></i> Files
            </h5>
            <div class="d-flex gap-2">
                @if (files != null && files.Length > 0)
                {
                    <button class="btn btn-sm btn-outline-secondary" @onclick="DownloadAll">
                        <i class="bi bi-download"></i> Download All
                    </button>
                }
                @if (!isReadOnly)
                {
                    <button class="btn btn-sm btn-primary" @onclick="ToggleUploadForm">
                        <i class="bi @(showUploadForm ? "bi-chevron-up" : "bi-plus-circle")"></i>
                        @(showUploadForm ? "Hide" : "Upload")
                    </button>
                }
            </div>
        </div>

        <div class="card-body">
            @if (showUploadForm)
            {
                <div class="upload-section mb-4 p-3 border rounded">
                    <h6>Upload Files</h6>
                    
                    <div class="drop-zone @(isDragging ? "dragging" : "")" 
                         id="@($"dropZone-{Id}")"
                         @ondragenter="HandleDragEnter"
                         @ondragleave="HandleDragLeave"
                         @ondragover:preventDefault="true"
                         @ondrop="HandleDrop"
                         @ondrop:preventDefault="true">
                        <InputFile OnChange="HandleFileSelection" multiple class="d-none" id="@($"fileInput-{Id}")" @ref="inputFileElement" />
                        <label for="@($"fileInput-{Id}")" class="drop-zone-label">
                            <i class="bi bi-cloud-upload fs-1"></i>
                            <p class="mb-0">Drag & drop files here or click to browse</p>
                            <small class="text-muted">Maximum 100MB per file, up to 20 files at once</small>
                        </label>
                    </div>

                    @if (selectedFiles.Count > 0)
                    {
                        <div class="mt-3">
                            <h6>Selected Files (@selectedFiles.Count)</h6>
                            <ul class="list-group">
                                @foreach (var file in selectedFiles)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@file.Name (@FormatFileSize(file.Size))</span>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveFile(file)">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </li>
                                }
                            </ul>

                            <div class="mt-3">
                                <label class="form-label">Description (optional)</label>
                                <textarea class="form-control" rows="2" @bind="uploadDescription"></textarea>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Tags (optional)</label>
                                <input type="text" class="form-control" @bind="uploadTags" placeholder="e.g., contract, invoice, documentation" />
                                <small class="text-muted">Comma-separated tags</small>
                            </div>

                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-primary" @onclick="UploadFiles" disabled="@isUploading">
                                    @if (isUploading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                        <text>Uploading...</text>
                                    }
                                    else
                                    {
                                        <i class="bi bi-upload me-1"></i>
                                        <text>Upload @selectedFiles.Count File@(selectedFiles.Count != 1 ? "s" : "")</text>
                                    }
                                </button>
                                <button class="btn btn-secondary" @onclick="ClearSelection" disabled="@isUploading">
                                    Cancel
                                </button>
                            </div>

                            @if (uploadProgress > 0 && isUploading)
                            {
                                <div class="progress mt-3">
                                    <div class="progress-bar" style="width: @uploadProgress%">@uploadProgress%</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            @if (errorMessage != null)
            {
                <div class="alert alert-danger alert-dismissible">
                    @errorMessage
                    <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
                </div>
            }

            @if (successMessage != null)
            {
                <div class="alert alert-success alert-dismissible text-white">
                    @successMessage
                    <button type="button" class="btn-close btn-close-white" @onclick="() => successMessage = null"></button>
                </div>
            }

            @if (quota != null)
            {
                <div class="quota-info mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">Storage: @FormatFileSize(quota.UsedBytes) / @FormatFileSize(quota.QuotaBytes) (@quota.FileCount files)</small>
                        <div class="progress flex-grow-1 ms-3" style="max-width: 200px; height: 8px;">
                            <div class="progress-bar @(GetQuotaBarClass())" style="width: @GetQuotaPercentage()%"></div>
                        </div>
                    </div>
                </div>
            }

            <div class="search-filter-section mb-3">
                <div class="row g-2">
                    <div class="col-md-4">
                        <input type="text" class="form-control form-control-sm" placeholder="Search files..." @bind="searchQuery" @bind:event="oninput" @onkeyup="HandleSearch" />
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" @bind="filterTag" @bind:after="ApplyFilters">
                            <option value="">All Tags</option>
                            @if (allTags != null)
                            {
                                @foreach (var tag in allTags)
                                {
                                    <option value="@tag">@tag</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" @bind="filterContentType" @bind:after="ApplyFilters">
                            <option value="">All Types</option>
                            <option value="image/">Images</option>
                            <option value="application/pdf">PDFs</option>
                            <option value="application/vnd">Documents</option>
                            <option value="text/">Text Files</option>
                        </select>
                    </div>
                    @if (!string.IsNullOrEmpty(searchQuery) || !string.IsNullOrEmpty(filterTag) || !string.IsNullOrEmpty(filterContentType))
                    {
                        <div class="col-md-2">
                            <button class="btn btn-sm btn-outline-secondary w-100" @onclick="ClearFilters">
                                <i class="bi bi-x-circle"></i> Clear
                            </button>
                        </div>
                    }
                </div>
            </div>

            @if (selectedFileIds.Count > 0)
            {
                <div class="bulk-actions mb-3 p-2 bg-light border rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>@selectedFileIds.Count</strong> file(s) selected</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" @onclick="ShowBulkMetadataEdit">
                                <i class="bi bi-pencil"></i> Edit Metadata
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="DeleteSelectedFiles">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSelection">
                                Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
            }

            @if (showBulkEdit)
            {
                <div class="bulk-edit-form mb-3 p-3 border rounded bg-light">
                    <h6>Bulk Edit Metadata</h6>
                    <div class="mb-2">
                        <label class="form-label">Description</label>
                        <textarea class="form-control form-control-sm" rows="2" @bind="bulkEditDescription"></textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Add Tags</label>
                        <input type="text" class="form-control form-control-sm" @bind="bulkEditTags" placeholder="Comma-separated tags" />
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-primary" @onclick="SaveBulkMetadata">Save</button>
                        <button class="btn btn-sm btn-secondary" @onclick="() => showBulkEdit = false">Cancel</button>
                    </div>
                </div>
            }

            @if (files == null)
            {
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (files.Length == 0)
            {
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p>No files uploaded yet</p>
                </div>
            }
            else
            {
                <div class="file-list">
                    <div class="d-none d-md-block">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" 
                                               @onchange="ToggleSelectAll"
                                               checked="@(selectedFileIds.Count == files.Length)" />
                                    </th>
                                    <th style="width: 60px;"></th>
                                    <th>Name</th>
                                    <th>Size</th>
                                    <th>Uploaded</th>
                                    <th>Tags</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var file in files)
                                {
                                    <tr class="@(selectedFileIds.Contains(file.Id) ? "table-active" : "")">
                                        <td>
                                            <input type="checkbox" class="form-check-input" 
                                                   checked="@selectedFileIds.Contains(file.Id)"
                                                   @onchange="() => ToggleFileSelection(file.Id)" />
                                        </td>
                                        <td>
                                            @if (file.HasThumbnail)
                                            {
                                                <img src="@FilesApi.GetThumbnailUrl(file.Id)" alt="Thumbnail" class="file-thumbnail" />
                                            }
                                            else
                                            {
                                                <i class="bi @GetFileIcon(file.ContentType) fs-4"></i>
                                            }
                                        </td>
                                        <td>
                                            <div>
                                                <strong>@file.OriginalFileName</strong>
                                                @if (!string.IsNullOrEmpty(file.Description))
                                                {
                                                    <br/><small class="text-muted">@file.Description</small>
                                                }
                                            </div>
                                        </td>
                                        <td><small>@FormatFileSize(file.FileSizeBytes)</small></td>
                                        <td>
                                            <small>
                                                @file.UploadedAt.ToLocalTime().ToString("g")<br/>
                                                <span class="text-muted">by @file.UploadedBy</span>
                                            </small>
                                        </td>
                                        <td>
                                            @if (file.Tags != null && file.Tags.Length > 0)
                                            {
                                                @foreach (var tag in file.Tags)
                                                {
                                                    <span class="badge bg-secondary me-1">@tag</span>
                                                }
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" @onclick="() => DownloadFile(file.Id, file.OriginalFileName)">
                                                    <i class="bi bi-download"></i>
                                                </button>
                                                @if (!isReadOnly)
                                                {
                                                    <button class="btn btn-outline-secondary" @onclick="() => StartEditFile(file)">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" @onclick="() => DeleteFile(file.Id)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Mobile view -->
                    <div class="d-md-none">
                        @foreach (var file in files)
                        {
                            <div class="card mb-2 @(selectedFileIds.Contains(file.Id) ? "border-primary" : "")">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="d-flex align-items-start gap-2 flex-grow-1">
                                            <input type="checkbox" class="form-check-input mt-1" 
                                                   checked="@selectedFileIds.Contains(file.Id)"
                                                   @onchange="() => ToggleFileSelection(file.Id)" />
                                            @if (file.HasThumbnail)
                                            {
                                                <img src="@FilesApi.GetThumbnailUrl(file.Id)" alt="Thumbnail" class="file-thumbnail" />
                                            }
                                            else
                                            {
                                                <i class="bi @GetFileIcon(file.ContentType) fs-4"></i>
                                            }
                                            <div class="flex-grow-1">
                                                <strong class="d-block">@file.OriginalFileName</strong>
                                                <small class="text-muted d-block">@FormatFileSize(file.FileSizeBytes)</small>
                                                <small class="text-muted d-block">@file.UploadedAt.ToLocalTime().ToString("g")</small>
                                            </div>
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(file.Description))
                                    {
                                        <p class="small mb-2">@file.Description</p>
                                    }
                                    @if (file.Tags != null && file.Tags.Length > 0)
                                    {
                                        <div class="mb-2">
                                            @foreach (var tag in file.Tags)
                                            {
                                                <span class="badge bg-secondary me-1">@tag</span>
                                            }
                                        </div>
                                    }
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => DownloadFile(file.Id, file.OriginalFileName)">
                                            <i class="bi bi-download"></i> Download
                                        </button>
                                        @if (!isReadOnly)
                                        {
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => StartEditFile(file)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteFile(file.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    @if (editingFile != null)
    {
        <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit File Metadata</h5>
                        <button type="button" class="btn-close" @onclick="CancelEdit"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="3" @bind="editDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" @bind="editTags" placeholder="Comma-separated tags" />
                            <small class="text-muted">Available tags: @string.Join(", ", allTags ?? Array.Empty<string>())</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveEdit">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
    }

    .drop-zone:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }

    .drop-zone.dragging {
        border-color: #0d6efd;
        background-color: #e7f1ff;
    }

    .drop-zone-label {
        cursor: pointer;
        display: block;
        margin: 0;
    }

    .file-thumbnail {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }

    .modal.show {
        display: block !important;
    }
</style>

@code {
    [Parameter] public string EntityType { get; set; } = string.Empty;
    [Parameter] public int EntityId { get; set; }
    [Parameter] public bool isReadOnly { get; set; } = false;
    
    private string Id = Guid.NewGuid().ToString();
    private EntityFileDto[]? files;
    private FileQuotaDto? quota;
    private string[]? allTags;
    
    private bool showUploadForm = false;
    private List<IBrowserFile> selectedFiles = new();
    private bool isUploading = false;
    private int uploadProgress = 0;
    private string? uploadDescription;
    private string? uploadTags;
    private bool isDragging = false;
    private InputFile? inputFileElement;
    
    private string? searchQuery;
    private string? filterTag;
    private string? filterContentType;
    
    private HashSet<int> selectedFileIds = new();
    private bool showBulkEdit = false;
    private string? bulkEditDescription;
    private string? bulkEditTags;
    
    private EntityFileDto? editingFile;
    private string? editDescription;
    private string? editTags;
    
    private string? errorMessage;
    private string? successMessage;
    private System.Threading.Timer? successMessageTimer;
    
    private IJSObjectReference? module;
    private DotNetObjectReference<FileManager>? dotNetHelper;
    private bool dropZoneInitialized = false;

    protected override async Task OnParametersSetAsync()
    {
        await LoadFiles();
        await LoadQuota();
        await LoadTags();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/fileUpload.js");
                dotNetHelper = DotNetObjectReference.Create(this);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading file upload module: {ex.Message}");
            }
        }
        
        // Initialize drop zone when upload form is shown and not yet initialized
        if (showUploadForm && !dropZoneInitialized && module != null)
        {
            try
            {
                await InitializeDropZone();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing file drop zone: {ex.Message}");
            }
        }
    }
    
    private async Task InitializeDropZone()
    {
        if (module != null && !dropZoneInitialized)
        {
            var result = await module.InvokeAsync<bool>("initializeFileDropZone", $"dropZone-{Id}", $"fileInput-{Id}", dotNetHelper);
            if (result)
            {
                dropZoneInitialized = true;
                Console.WriteLine("Drop zone initialized successfully");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            successMessageTimer?.Dispose();
            if (module != null)
            {
                await module.InvokeVoidAsync("cleanupFileDropZone", $"dropZone-{Id}");
                await module.DisposeAsync();
            }
            dotNetHelper?.Dispose();
        }
        catch (Exception)
        {
            // Ignore disposal errors
        }
    }

    private async Task LoadFiles()
    {
        files = await FilesApi.GetFilesAsync(EntityType, EntityId);
    }

    private async Task LoadQuota()
    {
        quota = await FilesApi.GetQuotaAsync(EntityType, EntityId);
    }

    private async Task LoadTags()
    {
        allTags = await FilesApi.GetAllTagsAsync(EntityType, EntityId);
    }

    private void HandleDragEnter(DragEventArgs e)
    {
        isDragging = true;
    }

    private void HandleDragLeave(DragEventArgs e)
    {
        isDragging = false;
    }

    private async Task HandleDrop(DragEventArgs e)
    {
        isDragging = false;
        
        // In Blazor, we need to use JavaScript interop to handle dropped files
        // The InputFile component will handle the files when we trigger it programmatically
        // For now, we'll use a workaround by using the module to handle drop events
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "Drop event detected");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error handling drop: {ex.Message}";
        }
    }

    private void HandleFileSelection(InputFileChangeEventArgs e)
    {
        var newFiles = e.GetMultipleFiles(20);
        
        // Check for duplicates
        foreach (var file in newFiles)
        {
            if (!selectedFiles.Any(f => f.Name == file.Name && f.Size == file.Size))
            {
                selectedFiles.Add(file);
            }
        }
    }

    private void RemoveFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
    }

    private void ClearSelection()
    {
        selectedFiles.Clear();
        uploadDescription = null;
        uploadTags = null;
        showUploadForm = false;
        dropZoneInitialized = false;
        selectedFileIds.Clear();
    }
    
    private void ToggleUploadForm()
    {
        showUploadForm = !showUploadForm;
        if (!showUploadForm)
        {
            dropZoneInitialized = false;
        }
    }
    
    private void SetSuccessMessage(string message)
    {
        successMessage = message;
        
        // Dispose existing timer if any
        successMessageTimer?.Dispose();
        
        // Create new timer to clear message after 3 seconds
        successMessageTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                successMessage = null;
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(3), Timeout.InfiniteTimeSpan);
    }

    private async Task UploadFiles()
    {
        if (selectedFiles.Count == 0) return;

        isUploading = true;
        errorMessage = null;
        successMessage = null;
        uploadProgress = 0;

        try
        {
            string[]? tags = null;
            if (!string.IsNullOrEmpty(uploadTags))
            {
                tags = uploadTags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
            }

            if (selectedFiles.Count == 1)
            {
                var result = await FilesApi.UploadFileAsync(
                    EntityType, 
                    EntityId, 
                    selectedFiles[0], 
                    uploadDescription,
                    tags,
                    100 * 1024 * 1024);

                if (result != null)
                {
                    SetSuccessMessage("File uploaded successfully!");
                }
                else
                {
                    errorMessage = "Failed to upload file.";
                }
            }
            else
            {
                var results = await FilesApi.UploadBatchAsync(
                    EntityType,
                    EntityId,
                    selectedFiles,
                    uploadDescription,
                    100 * 1024 * 1024);

                if (results != null && results.Length > 0)
                {
                    SetSuccessMessage($"{results.Length} file(s) uploaded successfully!");
                }
                else
                {
                    errorMessage = "Failed to upload files.";
                }
            }

            await LoadFiles();
            await LoadQuota();
            await LoadTags();
            ClearSelection();
        }
        catch (Exception ex)
        {
            errorMessage = $"Upload failed: {ex.Message}";
        }
        finally
        {
            isUploading = false;
            uploadProgress = 0;
        }
    }

    private async Task HandleSearch()
    {
        await ApplyFilters();
    }

    private async Task ApplyFilters()
    {
        if (string.IsNullOrEmpty(searchQuery) && string.IsNullOrEmpty(filterTag) && string.IsNullOrEmpty(filterContentType))
        {
            await LoadFiles();
        }
        else
        {
            files = await FilesApi.SearchFilesAsync(EntityType, EntityId, searchQuery, filterTag, filterContentType);
        }
    }

    private async Task ClearFilters()
    {
        searchQuery = null;
        filterTag = null;
        filterContentType = null;
        await LoadFiles();
    }

    private void ToggleFileSelection(int fileId)
    {
        if (selectedFileIds.Contains(fileId))
        {
            selectedFileIds.Remove(fileId);
        }
        else
        {
            selectedFileIds.Add(fileId);
        }
    }

    private void ToggleSelectAll(ChangeEventArgs e)
    {
        if ((bool)(e.Value ?? false))
        {
            selectedFileIds = files!.Select(f => f.Id).ToHashSet();
        }
        else
        {
            selectedFileIds.Clear();
        }
    }

    private void ShowBulkMetadataEdit()
    {
        showBulkEdit = true;
        bulkEditDescription = null;
        bulkEditTags = null;
    }

    private async Task SaveBulkMetadata()
    {
        string[]? tags = null;
        if (!string.IsNullOrEmpty(bulkEditTags))
        {
            tags = bulkEditTags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        }

        var success = await FilesApi.BatchUpdateMetadataAsync(
            selectedFileIds.ToList(),
            bulkEditDescription,
            tags);

        if (success)
        {
            SetSuccessMessage("Metadata updated successfully!");
            await LoadFiles();
            await LoadTags();
            showBulkEdit = false;
            selectedFileIds.Clear();
        }
        else
        {
            errorMessage = "Failed to update metadata.";
        }
    }

    private void StartEditFile(EntityFileDto file)
    {
        editingFile = file;
        editDescription = file.Description;
        editTags = file.Tags != null ? string.Join(", ", file.Tags) : "";
    }

    private void CancelEdit()
    {
        editingFile = null;
        editDescription = null;
        editTags = null;
    }

    private async Task SaveEdit()
    {
        if (editingFile == null) return;

        string[]? tags = null;
        if (!string.IsNullOrEmpty(editTags))
        {
            tags = editTags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        }

        var dto = new EntityFileUpdateDto(editDescription, tags);
        var success = await FilesApi.UpdateFileMetadataAsync(editingFile.Id, dto);

        if (success)
        {
            SetSuccessMessage("File metadata updated!");
            await LoadFiles();
            await LoadTags();
            CancelEdit();
        }
        else
        {
            errorMessage = "Failed to update metadata.";
        }
    }

    private async Task DeleteFile(int fileId)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this file?");
        if (!confirmed) return;

        var success = await FilesApi.DeleteFileAsync(fileId);
        if (success)
        {
            SetSuccessMessage("File deleted successfully!");
            await LoadFiles();
            await LoadQuota();
        }
        else
        {
            errorMessage = "Failed to delete file.";
        }
    }

    private async Task DeleteSelectedFiles()
    {
        if (selectedFileIds.Count == 0) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {selectedFileIds.Count} file(s)?");
        if (!confirmed) return;

        int deletedCount = 0;
        foreach (var fileId in selectedFileIds.ToList())
        {
            var success = await FilesApi.DeleteFileAsync(fileId);
            if (success) deletedCount++;
        }

        if (deletedCount > 0)
        {
            SetSuccessMessage($"{deletedCount} file(s) deleted successfully!");
            await LoadFiles();
            await LoadQuota();
            selectedFileIds.Clear();
        }
        else
        {
            errorMessage = "Failed to delete files.";
        }
    }

    private async Task DownloadFile(int fileId, string fileName)
    {
        try
        {
            var result = await FilesApi.DownloadFileAsync(fileId);
            if (result == null)
            {
                errorMessage = "Failed to download file";
                return;
            }

            var (data, contentType, downloadFileName) = result.Value;
            
            // Use the original fileName if provided, otherwise use the one from the response
            var finalFileName = !string.IsNullOrEmpty(fileName) ? fileName : downloadFileName;
            
            // Convert byte array to base64 and trigger download via JavaScript
            var base64 = Convert.ToBase64String(data);
            await JSRuntime.InvokeVoidAsync("eval", $@"
                const byteCharacters = atob('{base64}');
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {{
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }}
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {{ type: '{contentType}' }});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '{finalFileName.Replace("'", "\\'")}';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            ");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to download file: {ex.Message}";
        }
    }

    private async Task DownloadAll()
    {
        try
        {
            var url = FilesApi.GetDownloadAllUrl(EntityType, EntityId);
            var fileName = $"{EntityType}_{EntityId}_files.zip";
            // Use fetch API to download the file
            await JSRuntime.InvokeVoidAsync("eval", $@"
                fetch('{url}')
                    .then(response => response.blob())
                    .then(blob => {{
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = '{fileName}';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    }})
                    .catch(err => console.error('Download failed:', err));
            ");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to download files: {ex.Message}";
        }
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetFileIcon(string contentType)
    {
        return contentType.ToLower() switch
        {
            var ct when ct.StartsWith("image/") => "bi-file-image",
            var ct when ct.StartsWith("video/") => "bi-file-play",
            var ct when ct.StartsWith("audio/") => "bi-file-music",
            "application/pdf" => "bi-file-pdf",
            var ct when ct.Contains("word") => "bi-file-word",
            var ct when ct.Contains("excel") || ct.Contains("spreadsheet") => "bi-file-excel",
            var ct when ct.Contains("powerpoint") || ct.Contains("presentation") => "bi-file-ppt",
            var ct when ct.StartsWith("text/") => "bi-file-text",
            var ct when ct.Contains("zip") || ct.Contains("rar") || ct.Contains("7z") => "bi-file-zip",
            _ => "bi-file-earmark"
        };
    }

    private double GetQuotaPercentage()
    {
        if (quota == null || quota.QuotaBytes == 0) return 0;
        return (double)quota.UsedBytes / quota.QuotaBytes * 100;
    }

    private string GetQuotaBarClass()
    {
        var percentage = GetQuotaPercentage();
        if (percentage >= 90) return "bg-danger";
        if (percentage >= 75) return "bg-warning";
        return "bg-success";
    }
}
