@page "/orders"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Ligot.Web.Services
@inject OrderApiClient OrderApi
@inject CustomerApiClient CustomerApi
@inject IJSRuntime JSRuntime
@inject LocalizationService Localizer
@inject AuthorizationService AuthService
@implements IDisposable

<PageTitle>@Localizer.GetString("Orders")</PageTitle>

<PageAccessGuard PageName="Orders">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">@Localizer.GetString("Orders / Contracts")</h1>
    @if (!isReadOnly)
    {
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle me-2"></i>
            @Localizer.GetString("Create Order")
        </button>
    }
</div>

@if (showToast && !string.IsNullOrEmpty(toastMessage))
{
    <div class="alert @(toastType == "success" ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @toastMessage
        <button type="button" class="btn-close" @onclick="() => showToast = false"></button>
    </div>
}

<div class="row g-3 mb-3">
    <div class="col-md-3">
        <label class="form-label">@Localizer.GetString("Search")</label>
        <input type="text" class="form-control" @bind="searchText" @bind:event="oninput" @onkeyup="ApplyFilters" placeholder='@Localizer.GetString("Order number, customer...")' />
    </div>
    <div class="col-md-2">
        <label class="form-label">@Localizer.GetString("Contract Type")</label>
        <select class="form-select" @bind="filterContractType" @bind:after="ApplyFilters">
            <option value="">@Localizer.GetString("All Types")</option>
            @foreach (var type in availableContractTypes)
            {
                <option value="@type">@type</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">@Localizer.GetString("Status")</label>
        <select class="form-select" @bind="filterStatus" @bind:after="ApplyFilters">
            <option value="">@Localizer.GetString("All Status")</option>
            @foreach (var status in availableStatuses)
            {
                <option value="@status">@status</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <label class="form-label">@Localizer.GetString("Start Date From")</label>
        <input type="date" class="form-control" @bind="filterStartDateFrom" @bind:after="ApplyFilters" />
    </div>
    <div class="col-md-2">
        <label class="form-label">@Localizer.GetString("Start Date To")</label>
        <input type="date" class="form-control" @bind="filterStartDateTo" @bind:after="ApplyFilters" />
    </div>
    <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-outline-secondary w-100" @onclick="ClearFilters">@Localizer.GetString("Clear")</button>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@Localizer.GetString("Loading...")</span>
        </div>
    </div>
}
else if (filteredOrders.Length == 0)
{
    <div class="alert alert-info">
        @Localizer.GetString("No orders found. Create one to get started!")
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>
                        <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(OrdersSortColumn.OrderNumber)" aria-label="Sort by order number">
                            <span>@Localizer.GetString("Order Number")</span>
                            <span class="sort-indicator text-muted small">@GetSortIndicator(OrdersSortColumn.OrderNumber)</span>
                        </button>
                    </th>
                    <th>
                        <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(OrdersSortColumn.Customer)" aria-label="Sort by customer">
                            <span>@Localizer.GetString("Customer")</span>
                            <span class="sort-indicator text-muted small">@GetSortIndicator(OrdersSortColumn.Customer)</span>
                        </button>
                    </th>
                    <th>
                        <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(OrdersSortColumn.ContractType)" aria-label="Sort by contract type">
                            <span>@Localizer.GetString("Contract Type")</span>
                            <span class="sort-indicator text-muted small">@GetSortIndicator(OrdersSortColumn.ContractType)</span>
                        </button>
                    </th>
                    <th>
                        <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(OrdersSortColumn.StartDate)" aria-label="Sort by start date">
                            <span>@Localizer.GetString("Start Date")</span>
                            <span class="sort-indicator text-muted small">@GetSortIndicator(OrdersSortColumn.StartDate)</span>
                        </button>
                    </th>
                    <th>@Localizer.GetString("End Date")</th>
                    <th>
                        <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(OrdersSortColumn.Status)" aria-label="Sort by status">
                            <span>@Localizer.GetString("Status")</span>
                            <span class="sort-indicator text-muted small">@GetSortIndicator(OrdersSortColumn.Status)</span>
                        </button>
                    </th>
                    <th class="text-end">@Localizer.GetString("Contract Value")</th>
                    <th>@Localizer.GetString("Actions")</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in pagedOrders)
                {
                    <tr>
                        <td><strong>@order.OrderNumber</strong></td>
                        <td>@GetCustomerName(order)</td>
                        <td>@order.ContractType</td>
                        <td>@order.StartDate.ToString("yyyy-MM-dd")</td>
                        <td>@(order.EndDate?.ToString("yyyy-MM-dd") ?? "-")</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(order.Status)">
                                @(order.Status ?? Localizer.GetString("Unknown"))
                            </span>
                        </td>
                        <td class="text-end">
                            @if (order.ContractValue.HasValue)
                            {
                                <text>@order.ContractValue.Value.ToString("C")</text>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-info me-1" @onclick="() => ShowDetailsModal(order)">
                                <i class="bi bi-eye"></i>
                            </button>
                            @if (!isReadOnly)
                            {
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ShowEditModal(order)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteOrder(order.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            <span class="text-muted">
                @Localizer.GetString("Showing") @pagedOrders.Length @Localizer.GetString("of") @filteredOrders.Length @Localizer.GetString("orders")
            </span>
        </div>
        <div>
            <span class="me-2">@Localizer.GetString("Items per page:")</span>
            <select class="form-select form-select-sm d-inline-block" style="width: auto;" @bind="pageSize" @bind:after="UpdatePagination">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>
    <nav aria-label="Orders pagination" class="mt-2">
        <ul class="pagination pagination-sm justify-content-center mb-0">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(1)" disabled="@(currentPage == 1)">
                    @Localizer.GetString("First")
                </button>
            </li>
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                    @Localizer.GetString("Previous")
                </button>
            </li>
            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
            {
                <li class="page-item @(currentPage == i ? "active" : "")">
                    <button class="page-link" @onclick="() => GoToPage(i)">@i</button>
                </li>
            }
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                    @Localizer.GetString("Next")
                </button>
            </li>
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(totalPages)" disabled="@(currentPage == totalPages)">
                    @Localizer.GetString("Last")
                </button>
            </li>
        </ul>
    </nav>
}

@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer.GetString(editingOrder.Id == 0 ? "Create Order" : "Edit Order")</h5>
                    <button type="button" class="btn-close" @onclick="HideModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="editingOrder" OnValidSubmit="SaveOrder">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Customer") *</label>
                                <InputSelect TValue="int" class="form-select" @bind-Value="editingOrder.CustomerId">
                                    <option value="0">-- @Localizer.GetString("Select Customer") --</option>
                                    @if (customers != null)
                                    {
                                        @foreach (var customer in customers)
                                        {
                                            <option value="@customer.Id">@customer.Name</option>
                                        }
                                    }
                                </InputSelect>
                                <ValidationMessage For="() => editingOrder.CustomerId" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Order Number") *</label>
                                <InputText class="form-control" @bind-Value="editingOrder.OrderNumber" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Contract Type") *</label>
                                <InputText class="form-control" @bind-Value="editingOrder.ContractType" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Status")</label>
                                <InputText class="form-control" @bind-Value="editingOrder.Status" />
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <label class="form-label">@Localizer.GetString("Start Date")</label>
                                <InputDate class="form-control" @bind-Value="editingOrder.StartDate" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">@Localizer.GetString("End Date")</label>
                                <InputDate class="form-control" @bind-Value="editingOrder.EndDate" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">@Localizer.GetString("Billing Frequency")</label>
                                <InputText class="form-control" @bind-Value="editingOrder.BillingFrequency" />
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Contract Value")</label>
                                <InputNumber class="form-control" @bind-Value="editingOrder.ContractValue" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Description")</label>
                                <InputTextArea class="form-control" rows="3" @bind-Value="editingOrder.Description" />
                            </div>
                        </div>
                        <div class="modal-footer mt-3">
                            <button type="button" class="btn btn-secondary" @onclick="HideModal">@Localizer.GetString("Cancel")</button>
                            <button type="submit" class="btn btn-primary" disabled="@isSavingOrder">
                                @if (isSavingOrder)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    @Localizer.GetString("Saving...")
                                }
                                else
                                {
                                    @Localizer.GetString(editingOrder.Id == 0 ? "Create Order" : "Save Order")
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@if (selectedOrder != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer.GetString("Order Details")</h5>
                    <button type="button" class="btn-close" @onclick="HideDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row gy-3">
                        <div class="col-md-6">
                            <dl class="row mb-0">
                                <dt class="col-sm-4">@Localizer.GetString("Order Number")</dt>
                                <dd class="col-sm-8">@selectedOrder.OrderNumber</dd>
                                <dt class="col-sm-4">@Localizer.GetString("Customer")</dt>
                                <dd class="col-sm-8">@selectedOrder.CustomerName</dd>
                                <dt class="col-sm-4">@Localizer.GetString("Contract Type")</dt>
                                <dd class="col-sm-8">@selectedOrder.ContractType</dd>
                                <dt class="col-sm-4">@Localizer.GetString("Status")</dt>
                                <dd class="col-sm-8">
                                    <span class="badge @GetStatusBadgeClass(selectedOrder.Status)">
                                        @(selectedOrder.Status ?? Localizer.GetString("Unknown"))
                                    </span>
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row mb-0">
                                <dt class="col-sm-5">@Localizer.GetString("Start Date")</dt>
                                <dd class="col-sm-7">@selectedOrder.StartDate.ToString("yyyy-MM-dd")</dd>
                                <dt class="col-sm-5">@Localizer.GetString("End Date")</dt>
                                <dd class="col-sm-7">@(selectedOrder.EndDate?.ToString("yyyy-MM-dd") ?? "-")</dd>
                                <dt class="col-sm-5">@Localizer.GetString("Contract Value")</dt>
                                <dd class="col-sm-7">
                                    @(selectedOrder.ContractValue.HasValue ? selectedOrder.ContractValue.Value.ToString("C") : "-")
                                </dd>
                                <dt class="col-sm-5">@Localizer.GetString("Billing Frequency")</dt>
                                <dd class="col-sm-7">@(selectedOrder.BillingFrequency ?? "-")</dd>
                            </dl>
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(selectedOrder.Description))
                    {
                        <div class="mt-3">
                            <h6>@Localizer.GetString("Description")</h6>
                            <p class="mb-0">@selectedOrder.Description</p>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideDetailsModal">@Localizer.GetString("Close")</button>
                </div>
            </div>
        </div>
    </div>
}

</PageAccessGuard>

@code {
    private OrderWithCustomerDto[]? orders;
    private OrderWithCustomerDto[] filteredOrders = Array.Empty<OrderWithCustomerDto>();
    private OrderWithCustomerDto[] pagedOrders = Array.Empty<OrderWithCustomerDto>();
    private OrderWithCustomerDto? selectedOrder;

    private CustomerDto[]? customers;
    private bool isLoading = true;
    private bool showModal;
    private bool showToast;
    private string toastMessage = string.Empty;
    private string toastType = "success";
    private bool isSavingOrder;
    private OrderFormModel editingOrder = new();
    private bool isReadOnly = false;

    private List<string> availableContractTypes = new();
    private List<string> availableStatuses = new();

    private string searchText = string.Empty;
    private string filterContractType = string.Empty;
    private string filterStatus = string.Empty;
    private DateTime? filterStartDateFrom;
    private DateTime? filterStartDateTo;

    private int currentPage = 1;
    private int pageSize = 25;
    private int totalPages = 1;

    private OrdersSortColumn sortColumn = OrdersSortColumn.StartDate;
    private bool sortDescending = true;

    protected override async Task OnInitializedAsync()
    {
        Localizer.OnLanguageChanged += OnLanguageChanged;
        isReadOnly = await AuthService.IsPageReadOnlyAsync("Orders");
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        isLoading = true;
        try
        {
            orders = await OrderApi.GetOrdersAsync();
            customers = await CustomerApi.GetCustomersAsync();

            if (orders != null)
            {
                availableContractTypes = orders
                    .Select(o => o.ContractType)
                    .Where(ct => !string.IsNullOrWhiteSpace(ct))
                    .Select(ct => ct!)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .OrderBy(ct => ct)
                    .ToList();

                availableStatuses = orders
                    .Select(o => o.Status)
                    .Where(s => !string.IsNullOrWhiteSpace(s))
                    .Select(s => s!)
                    .Distinct(StringComparer.OrdinalIgnoreCase)
                    .OrderBy(s => s)
                    .ToList();
            }
            else
            {
                availableContractTypes.Clear();
                availableStatuses.Clear();
            }

            ApplyFilters();
        }
        catch (Exception ex)
        {
            ShowToast(Localizer.GetString("Error loading orders") + $": {ex.Message}", "danger");
            filteredOrders = Array.Empty<OrderWithCustomerDto>();
            pagedOrders = Array.Empty<OrderWithCustomerDto>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        if (orders == null)
        {
            filteredOrders = Array.Empty<OrderWithCustomerDto>();
            pagedOrders = Array.Empty<OrderWithCustomerDto>();
            totalPages = 1;
            currentPage = 1;
            return;
        }

        var result = orders.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.Trim().ToLowerInvariant();
            result = result.Where(o =>
                o.OrderNumber.ToLowerInvariant().Contains(search) ||
                o.CustomerName.ToLowerInvariant().Contains(search) ||
                (o.ContractType?.ToLowerInvariant().Contains(search) ?? false) ||
                (o.Description?.ToLowerInvariant().Contains(search) ?? false));
        }

        if (!string.IsNullOrWhiteSpace(filterContractType))
        {
            result = result.Where(o => o.ContractType == filterContractType);
        }

        if (!string.IsNullOrWhiteSpace(filterStatus))
        {
            result = result.Where(o => o.Status == filterStatus);
        }

        if (filterStartDateFrom.HasValue)
        {
            result = result.Where(o => o.StartDate >= filterStartDateFrom.Value);
        }

        if (filterStartDateTo.HasValue)
        {
            result = result.Where(o => o.StartDate <= filterStartDateTo.Value);
        }

        filteredOrders = result.ToArray();
        ApplySorting();
        currentPage = 1;
        UpdatePagination();
    }

    private void ClearFilters()
    {
        searchText = string.Empty;
        filterContractType = string.Empty;
        filterStatus = string.Empty;
        filterStartDateFrom = null;
        filterStartDateTo = null;
        ApplyFilters();
    }

    private void SetSortColumn(OrdersSortColumn column)
    {
        if (sortColumn == column)
        {
            sortDescending = !sortDescending;
        }
        else
        {
            sortColumn = column;
            sortDescending = false;
        }

        ApplyClientFilters();
    }

    private void ApplyClientFilters()
    {
        ApplySorting();
        currentPage = 1;
        UpdatePagination();
    }

    private void ApplySorting()
    {
        filteredOrders = sortColumn switch
        {
            OrdersSortColumn.OrderNumber => sortDescending
                ? filteredOrders.OrderByDescending(o => o.OrderNumber).ToArray()
                : filteredOrders.OrderBy(o => o.OrderNumber).ToArray(),
            OrdersSortColumn.Customer => sortDescending
                ? filteredOrders.OrderByDescending(o => GetCustomerName(o) ?? string.Empty).ToArray()
                : filteredOrders.OrderBy(o => GetCustomerName(o) ?? string.Empty).ToArray(),
            OrdersSortColumn.ContractType => sortDescending
                ? filteredOrders.OrderByDescending(o => o.ContractType).ToArray()
                : filteredOrders.OrderBy(o => o.ContractType).ToArray(),
            OrdersSortColumn.StartDate => sortDescending
                ? filteredOrders.OrderByDescending(o => o.StartDate).ToArray()
                : filteredOrders.OrderBy(o => o.StartDate).ToArray(),
            OrdersSortColumn.Status => sortDescending
                ? filteredOrders.OrderByDescending(o => o.Status ?? string.Empty).ToArray()
                : filteredOrders.OrderBy(o => o.Status ?? string.Empty).ToArray(),
            _ => filteredOrders
        };
    }

    private string GetSortIndicator(OrdersSortColumn column)
    {
        if (sortColumn != column)
        {
            return string.Empty;
        }

        return sortDescending ? "▼" : "▲";
    }

    private string GetCustomerName(OrderWithCustomerDto order)
    {
        // If customer name is "Unknown", try to find it from the loaded customers list
        if (order.CustomerName == "Unknown" && customers != null)
        {
            var customer = customers.FirstOrDefault(c => c.Id == order.CustomerId);
            return customer?.Name ?? order.CustomerName;
        }
        return order.CustomerName;
    }

    private void UpdatePagination()
    {
        totalPages = (int)Math.Ceiling(filteredOrders.Length / (double)pageSize);
        if (totalPages == 0) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        var skip = (currentPage - 1) * pageSize;
        pagedOrders = filteredOrders.Skip(skip).Take(pageSize).ToArray();
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        UpdatePagination();
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "active" => "bg-success",
            "expired" => "bg-danger",
            "pending" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private void ShowCreateModal()
    {
        editingOrder = new OrderFormModel
        {
            StartDate = DateTime.Today
        };
        showModal = true;
    }

    private void ShowEditModal(OrderWithCustomerDto order)
    {
        editingOrder = new OrderFormModel
        {
            Id = order.Id,
            CustomerId = order.CustomerId,
            OrderNumber = order.OrderNumber,
            ContractType = order.ContractType,
            StartDate = order.StartDate,
            EndDate = order.EndDate,
            ContractValue = order.ContractValue,
            BillingFrequency = order.BillingFrequency,
            Status = order.Status,
            Description = order.Description
        };
        showModal = true;
    }

    private void HideModal()
    {
        showModal = false;
        editingOrder = new OrderFormModel();
        isSavingOrder = false;
    }

    private async Task SaveOrder()
    {
        if (editingOrder.Id == 0)
        {
            await CreateOrderAsync();
        }
        else
        {
            await UpdateOrderAsync();
        }
    }

    private async Task CreateOrderAsync()
    {
        isSavingOrder = true;
        try
        {
            var dto = new OrderCreateDto(
                editingOrder.CustomerId,
                editingOrder.OrderNumber!,
                editingOrder.ContractType!,
                editingOrder.StartDate,
                editingOrder.EndDate,
                editingOrder.ContractValue,
                editingOrder.BillingFrequency,
                editingOrder.Status,
                editingOrder.Description);

            var created = await OrderApi.CreateOrderAsync(dto);
            if (created != null)
            {
                ShowToast(Localizer.GetString("Order created successfully!"), "success");
                await LoadOrdersAsync();
                HideModal();
            }
            else
            {
                ShowToast(Localizer.GetString("Failed to create order"), "danger");
            }
        }
        catch (Exception ex)
        {
            ShowToast(Localizer.GetString("Error saving order") + $": {ex.Message}", "danger");
        }
        finally
        {
            isSavingOrder = false;
        }
    }

    private async Task UpdateOrderAsync()
    {
        isSavingOrder = true;
        try
        {
            var dto = new OrderUpdateDto(
                editingOrder.Id,
                editingOrder.CustomerId,
                editingOrder.OrderNumber!,
                editingOrder.ContractType!,
                editingOrder.StartDate,
                editingOrder.EndDate,
                editingOrder.ContractValue,
                editingOrder.BillingFrequency,
                editingOrder.Status,
                editingOrder.Description);

            var success = await OrderApi.UpdateOrderAsync(dto);
            if (success)
            {
                ShowToast(Localizer.GetString("Order updated successfully!"), "success");
                await LoadOrdersAsync();
                HideModal();
            }
            else
            {
                ShowToast(Localizer.GetString("Failed to update order"), "danger");
            }
        }
        catch (Exception ex)
        {
            ShowToast(Localizer.GetString("Error saving order") + $": {ex.Message}", "danger");
        }
        finally
        {
            isSavingOrder = false;
        }
    }

    private async Task DeleteOrder(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", Localizer.GetString("Confirm Delete Order"));
        if (!confirmed) return;

        var success = await OrderApi.DeleteOrderAsync(id);
        if (success)
        {
            ShowToast(Localizer.GetString("Order deleted successfully!"), "success");
            await LoadOrdersAsync();
        }
        else
        {
            ShowToast(Localizer.GetString("Failed to delete order"), "danger");
        }
    }

    private void ShowDetailsModal(OrderWithCustomerDto order)
    {
        selectedOrder = order;
    }

    private void HideDetailsModal()
    {
        selectedOrder = null;
    }

    private void ShowToast(string message, string type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Localizer.OnLanguageChanged -= OnLanguageChanged;
    }

    private class OrderFormModel
    {
        public int Id { get; set; }

        [Range(1, int.MaxValue, ErrorMessage = "Please select a customer")]
        public int CustomerId { get; set; }

        [Required]
        public string? OrderNumber { get; set; }

        [Required]
        public string? ContractType { get; set; }

        public DateTime StartDate { get; set; } = DateTime.Today;
        public DateTime? EndDate { get; set; }
        public decimal? ContractValue { get; set; }
        public string? Status { get; set; }
        public string? BillingFrequency { get; set; }
        public string? Description { get; set; }
    }

    private enum OrdersSortColumn
    {
        OrderNumber,
        Customer,
        ContractType,
        StartDate,
        Status
    }
}

