name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Run database migrations'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      migration_approval:
        description: 'Migration requires manual approval'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DOTNET_VERSION: '10.0.x'
  AZURE_RESOURCE_GROUP: 'rg-mycrm-production'
  AZURE_BACKEND_APP_NAME: 'app-mycrm-backend-prod'
  AZURE_FRONTEND_APP_NAME: 'app-mycrm-frontend-prod'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore and Build
      run: |
        dotnet restore AspireApp1.sln
        dotnet build AspireApp1.sln --no-restore --configuration Release
        
    - name: Run Tests
      run: dotnet test AspireApp1.sln --no-build --configuration Release --verbosity normal
        
    - name: Publish Backend
      run: dotnet publish AspireApp1.DbApi/AspireApp1.BackEnd.csproj -c Release -o ./publish/backend
      
    - name: Publish Frontend
      run: dotnet publish AspireApp1.Web/AspireApp1.FrontEnd.csproj -c Release -o ./publish/frontend
      
    - name: Upload Backend Artifact
      uses: actions/upload-artifact@v4.4.3
      with:
        name: backend-prod
        path: ./publish/backend
        retention-days: 30
        
    - name: Upload Frontend Artifact
      uses: actions/upload-artifact@v4.4.3
      with:
        name: frontend-prod
        path: ./publish/frontend
        retention-days: 30

  approve-migration:
    runs-on: ubuntu-latest
    needs: build
    if: inputs.run_migrations == 'true' && inputs.migration_approval == 'true'
    environment: production-migration-approval
    
    steps:
    - name: Manual Migration Approval
      run: echo "Migration approved by ${{ github.actor }}"

  deploy-production:
    runs-on: ubuntu-latest
    needs: [build, approve-migration]
    if: always() && (needs.approve-migration.result == 'success' || needs.approve-migration.result == 'skipped')
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Download Backend Artifact
      uses: actions/download-artifact@v4.1.3
      with:
        name: backend-prod
        path: ./publish/backend
        
    - name: Download Frontend Artifact
      uses: actions/download-artifact@v4.1.3
      with:
        name: frontend-prod
        path: ./publish/frontend
        
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Run Database Migrations (if approved)
      if: inputs.run_migrations == 'true'
      run: |
        dotnet tool install --global dotnet-ef
        dotnet ef database update --project AspireApp1.DbApi/AspireApp1.BackEnd.csproj --startup-project AspireApp1.DbApi/AspireApp1.BackEnd.csproj --connection "${{ secrets.PRODUCTION_DB_CONNECTION_STRING }}"
      env:
        ConnectionStrings__DefaultConnection: ${{ secrets.PRODUCTION_DB_CONNECTION_STRING }}
        
    - name: Deploy Backend to Staging Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_BACKEND_APP_NAME }}
        slot-name: 'staging'
        package: ./publish/backend
        
    - name: Deploy Frontend to Staging Slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_FRONTEND_APP_NAME }}
        slot-name: 'staging'
        package: ./publish/frontend
        
    - name: Staging Health Check
      run: |
        echo "Waiting for staging services to be ready..."
        sleep 30
        curl -f https://${{ env.AZURE_BACKEND_APP_NAME }}-staging.azurewebsites.net/health || exit 1
        curl -f https://${{ env.AZURE_FRONTEND_APP_NAME }}-staging.azurewebsites.net/health || exit 1
        
    - name: Swap Backend Staging to Production
      run: |
        az webapp deployment slot swap \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_BACKEND_APP_NAME }} \
          --slot staging \
          --target-slot production
          
    - name: Swap Frontend Staging to Production
      run: |
        az webapp deployment slot swap \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AZURE_FRONTEND_APP_NAME }} \
          --slot staging \
          --target-slot production
          
    - name: Production Health Check
      run: |
        echo "Waiting for production services to be ready..."
        sleep 30
        curl -f https://${{ env.AZURE_BACKEND_APP_NAME }}.azurewebsites.net/health || exit 1
        curl -f https://${{ env.AZURE_FRONTEND_APP_NAME }}.azurewebsites.net/health || exit 1
        
    - name: Notify Deployment Success
      run: |
        echo "âœ… Production deployment completed successfully"
        echo "Backend: https://${{ env.AZURE_BACKEND_APP_NAME }}.azurewebsites.net"
        echo "Frontend: https://${{ env.AZURE_FRONTEND_APP_NAME }}.azurewebsites.net"
