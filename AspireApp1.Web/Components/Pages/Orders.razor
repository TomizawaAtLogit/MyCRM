@page "/orders"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject OrderApiClient OrderApi
@inject NavigationManager Navigation

<PageTitle>Orders</PageTitle>

<h1>Orders / Contracts</h1>

<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Filter Orders</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" @bind="searchText" @bind:event="oninput" @onkeyup="ApplyFilters" placeholder="Order number, customer..." />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Contract Type</label>
                        <select class="form-select" @bind="filterContractType" @bind:after="ApplyFilters">
                            <option value="">All Types</option>
                            @foreach (var type in availableContractTypes)
                            {
                                <option value="@type">@type</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="filterStatus" @bind:after="ApplyFilters">
                            <option value="">All Status</option>
                            @foreach (var status in availableStatuses)
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Start Date From</label>
                        <input type="date" class="form-control" @bind="filterStartDateFrom" @bind:after="ApplyFilters" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Start Date To</label>
                        <input type="date" class="form-control" @bind="filterStartDateTo" @bind:after="ApplyFilters" />
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button class="btn btn-secondary w-100" @onclick="ClearFilters">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (orders == null)
{
    <p><em>Loading orders...</em></p>
}
else if (filteredOrders.Length == 0)
{
    <p class="text-muted">No orders found matching the filters.</p>
}
else
{
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Orders List (@filteredOrders.Length total)</h5>
            <div>
                <span class="me-2">Items per page:</span>
                <select class="form-select form-select-sm d-inline-block" style="width: auto;" @bind="pageSize" @bind:after="UpdatePagination">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="cursor: pointer;" @onclick='() => SortBy("OrderNumber")'>
                                Order Number @GetSortIcon("OrderNumber")
                            </th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("CustomerName")'>
                                Customer @GetSortIcon("CustomerName")
                            </th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("ContractType")'>
                                Contract Type @GetSortIcon("ContractType")
                            </th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("StartDate")'>
                                Start Date @GetSortIcon("StartDate")
                            </th>
                            <th>End Date</th>
                            <th style="cursor: pointer;" @onclick='() => SortBy("Status")'>
                                Status @GetSortIcon("Status")
                            </th>
                            <th class="text-end">Contract Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in pagedOrders)
                        {
                            <tr>
                                <td><strong>@order.OrderNumber</strong></td>
                                <td>@order.CustomerName</td>
                                <td>@order.ContractType</td>
                                <td>@order.StartDate.ToShortDateString()</td>
                                <td>@(order.EndDate?.ToShortDateString() ?? "-")</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(order.Status)">
                                        @(order.Status ?? "Unknown")
                                    </span>
                                </td>
                                <td class="text-end">
                                    @if (order.ContractValue.HasValue)
                                    {
                                        <text>¥@order.ContractValue.Value.ToString("N0")</text>
                                    }
                                    else
                                    {
                                        <text>-</text>
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ViewOrderDetails(order)">
                                        <span class="bi bi-eye"></span>
                                    </button>
                                    <a href="/customers?customerId=@order.CustomerId&tab=orders" class="btn btn-sm btn-outline-secondary">
                                        <span class="bi bi-person"></span> Customer
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer">
            <nav aria-label="Orders pagination">
                <ul class="pagination pagination-sm mb-0 justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(1)" disabled="@(currentPage == 1)">First</button>
                    </li>
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">Previous</button>
                    </li>
                    
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                        </li>
                    }
                    
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">Next</button>
                    </li>
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(totalPages)" disabled="@(currentPage == totalPages)">Last</button>
                    </li>
                </ul>
            </nav>
            <div class="text-center mt-2 text-muted">
                <small>Page @currentPage of @totalPages (showing @pagedOrders.Length of @filteredOrders.Length orders)</small>
            </div>
        </div>
    </div>
}

@if (selectedOrder != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Order Number:</strong> @selectedOrder.OrderNumber</p>
                            <p><strong>Customer:</strong> @selectedOrder.CustomerName</p>
                            <p><strong>Contract Type:</strong> @selectedOrder.ContractType</p>
                            <p><strong>Status:</strong> <span class="badge @GetStatusBadgeClass(selectedOrder.Status)">@(selectedOrder.Status ?? "Unknown")</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Start Date:</strong> @selectedOrder.StartDate.ToLongDateString()</p>
                            <p><strong>End Date:</strong> @(selectedOrder.EndDate?.ToLongDateString() ?? "N/A")</p>
                            <p><strong>Contract Value:</strong> @(selectedOrder.ContractValue.HasValue ? "¥" + selectedOrder.ContractValue.Value.ToString("N0") : "N/A")</p>
                            <p><strong>Billing Frequency:</strong> @(selectedOrder.BillingFrequency ?? "N/A")</p>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(selectedOrder.Description))
                    {
                        <hr />
                        <p><strong>Description:</strong></p>
                        <p>@selectedOrder.Description</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetails">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private OrderWithCustomerDto[]? orders;
    private OrderWithCustomerDto[] filteredOrders = Array.Empty<OrderWithCustomerDto>();
    private OrderWithCustomerDto[] pagedOrders = Array.Empty<OrderWithCustomerDto>();
    private OrderWithCustomerDto? selectedOrder;

    // Dynamic filter options
    private List<string> availableContractTypes = new();
    private List<string> availableStatuses = new();

    // Filter properties
    private string searchText = "";
    private string filterContractType = "";
    private string filterStatus = "";
    private DateTime? filterStartDateFrom;
    private DateTime? filterStartDateTo;

    // Pagination properties
    private int currentPage = 1;
    private int pageSize = 25;
    private int totalPages = 1;

    // Sorting properties
    private string sortColumn = "StartDate";
    private bool sortAscending = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        orders = await OrderApi.GetOrdersAsync();
        
        // Populate dynamic filter options from actual data
        if (orders != null)
        {
            availableContractTypes = orders
                .Select(o => o.ContractType)
                .Where(ct => !string.IsNullOrWhiteSpace(ct))
                .Distinct()
                .OrderBy(ct => ct)
                .ToList()!;
            
            availableStatuses = orders
                .Select(o => o.Status)
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .OrderBy(s => s)
                .ToList()!;
        }
        
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        if (orders == null)
        {
            filteredOrders = Array.Empty<OrderWithCustomerDto>();
            return;
        }

        var result = orders.AsEnumerable();

        // Search filter
        if (!string.IsNullOrWhiteSpace(searchText))
        {
            var search = searchText.ToLower();
            result = result.Where(o =>
                o.OrderNumber.ToLower().Contains(search) ||
                o.CustomerName.ToLower().Contains(search) ||
                (o.ContractType?.ToLower().Contains(search) ?? false) ||
                (o.Description?.ToLower().Contains(search) ?? false)
            );
        }

        // Contract type filter
        if (!string.IsNullOrWhiteSpace(filterContractType))
        {
            result = result.Where(o => o.ContractType == filterContractType);
        }

        // Status filter
        if (!string.IsNullOrWhiteSpace(filterStatus))
        {
            result = result.Where(o => o.Status == filterStatus);
        }

        // Date range filter
        if (filterStartDateFrom.HasValue)
        {
            result = result.Where(o => o.StartDate >= filterStartDateFrom.Value);
        }
        if (filterStartDateTo.HasValue)
        {
            result = result.Where(o => o.StartDate <= filterStartDateTo.Value);
        }

        filteredOrders = result.ToArray();
        ApplySorting();
        currentPage = 1;
        UpdatePagination();
    }

    private void ClearFilters()
    {
        searchText = "";
        filterContractType = "";
        filterStatus = "";
        filterStartDateFrom = null;
        filterStartDateTo = null;
        ApplyFilters();
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplySorting();
        UpdatePagination();
    }

    private void ApplySorting()
    {
        filteredOrders = sortColumn switch
        {
            "OrderNumber" => sortAscending 
                ? filteredOrders.OrderBy(o => o.OrderNumber).ToArray()
                : filteredOrders.OrderByDescending(o => o.OrderNumber).ToArray(),
            "CustomerName" => sortAscending 
                ? filteredOrders.OrderBy(o => o.CustomerName).ToArray()
                : filteredOrders.OrderByDescending(o => o.CustomerName).ToArray(),
            "ContractType" => sortAscending 
                ? filteredOrders.OrderBy(o => o.ContractType).ToArray()
                : filteredOrders.OrderByDescending(o => o.ContractType).ToArray(),
            "StartDate" => sortAscending 
                ? filteredOrders.OrderBy(o => o.StartDate).ToArray()
                : filteredOrders.OrderByDescending(o => o.StartDate).ToArray(),
            "Status" => sortAscending 
                ? filteredOrders.OrderBy(o => o.Status).ToArray()
                : filteredOrders.OrderByDescending(o => o.Status).ToArray(),
            _ => filteredOrders
        };
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "";
        return sortAscending ? "��" : "��";
    }

    private void UpdatePagination()
    {
        totalPages = (int)Math.Ceiling(filteredOrders.Length / (double)pageSize);
        if (totalPages == 0) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        var skip = (currentPage - 1) * pageSize;
        pagedOrders = filteredOrders.Skip(skip).Take(pageSize).ToArray();
    }

    private void GoToPage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        UpdatePagination();
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLower() switch
        {
            "active" => "bg-success",
            "expired" => "bg-danger",
            "pending" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }

    private void ViewOrderDetails(OrderWithCustomerDto order)
    {
        selectedOrder = order;
    }

    private void CloseDetails()
    {
        selectedOrder = null;
    }
}
