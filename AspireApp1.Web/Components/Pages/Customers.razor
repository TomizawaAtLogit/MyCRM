@page "/customers"
@rendermode InteractiveServer
@using System.ComponentModel.DataAnnotations
@using System.Net.Http
@using System.Text.Json
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@* @attribute [Authorize] *@ @* DISABLED FOR LOCAL DEVELOPMENT *@
@inject CustomerApiClient CustomerApi
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject LocalizationService Localizer
@implements IDisposable

<PageTitle>@Localizer.GetString("Customers")</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>@Localizer.GetString("Customers")</h1>
    @if (selectedCustomerDetails != null)
    {
        <button class="btn btn-secondary" @onclick="ClearSelection">
            <span class="bi bi-arrow-left"></span> @Localizer.GetString("Back to List")
        </button>
    }
</div>

@if (!string.IsNullOrEmpty(deleteErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @deleteErrorMessage
        <button type="button" class="btn-close" aria-label="Close" @onclick="() => deleteErrorMessage = null"></button>
    </div>
}

@if (selectedCustomerDetails == null)
{
    <div class="row mb-3">
        <div class="col-md-12">
            @if (customers == null)
            {
                <p><em>@Localizer.GetString("Loading customers...")</em></p>
            }
            else if (customers.Length == 0)
            {
                <p class="text-muted">@Localizer.GetString("No customers found.")</p>
            }
            else
            {
                <div class="list-group">
                    @foreach (var customer in customers)
                    {
                        <button type="button" class="list-group-item list-group-item-action text-start @(selectedCustomer?.Id == customer.Id ? "active" : "")"
                           @onclick="() => SelectCustomer(customer.Id)">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">@customer.Name</h5>
                                <small>@customer.CreatedAt.ToShortDateString()</small>
                            </div>
                            @if (!string.IsNullOrEmpty(customer.ContactPerson))
                            {
                                <p class="mb-1"><small>@Localizer.GetString("Contact:") @customer.ContactPerson</small></p>
                            }
                        </button>
                    }
                </div>
            }
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">@Localizer.GetString("Add New Customer")</h5>
                    <button class="btn btn-sm btn-outline-primary" @onclick="() => showCreateForm = !showCreateForm">
                        <i class="bi @(showCreateForm ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                </div>
                @if (showCreateForm)
                {
                    <div class="card-body">
                    <EditForm EditContext="createEditContext" OnValidSubmit="CreateCustomerAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Name *</label>
                                <InputText @bind-Value="newCustomer.Name" class="form-control" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Contact Person</label>
                                <InputText @bind-Value="newCustomer.ContactPerson" class="form-control" />
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Email</label>
                                <InputText @bind-Value="newCustomer.Email" class="form-control" type="email" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Phone</label>
                                <InputText @bind-Value="newCustomer.Phone" class="form-control" />
                            </div>
                            <div class="col-md-8 mb-3">
                                <label class="form-label">Address</label>
                                <InputTextArea @bind-Value="newCustomer.Address" class="form-control" rows="2" />
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Create Customer</button>
                    </EditForm>
                    </div>
                }
            </div>
        </div>
    </div>
}

@if (selectedCustomerDetails != null)
{
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">@selectedCustomerDetails.Name</h4>
            <div>
                @if (!isEditing)
                {
                    <button class="btn btn-outline-primary btn-sm me-2" @onclick="StartEdit">
                        <i class="bi bi-pencil"></i>
                    </button>
                }
                <button class="btn btn-outline-danger btn-sm" @onclick="() => ConfirmDeleteCustomer(selectedCustomerDetails.Id)">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (isEditing)
            {
                <div class="row mb-3">
                    <div class="col-12">
                        <EditForm EditContext="editEditContext" OnValidSubmit="SaveEdit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Name</label>
                                    <InputText @bind-Value="editModel.Name" class="form-control" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Contact Person</label>
                                    <InputText @bind-Value="editModel.ContactPerson" class="form-control" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email</label>
                                    <InputText @bind-Value="editModel.Email" class="form-control" type="email" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Phone</label>
                                    <InputText @bind-Value="editModel.Phone" class="form-control" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">Address</label>
                                    <InputTextArea @bind-Value="editModel.Address" class="form-control" rows="2" />
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="CancelEdit">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            }
            else
            {
                <div class="row mb-3">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Contact Person:</dt>
                            <dd class="col-sm-8">@(selectedCustomerDetails.ContactPerson ?? "-")</dd>
                            
                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8">
                                @if (!string.IsNullOrEmpty(selectedCustomerDetails.Email))
                                {
                                    <a href="mailto:@selectedCustomerDetails.Email">@selectedCustomerDetails.Email</a>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </dd>
                            
                            <dt class="col-sm-4">Phone:</dt>
                            <dd class="col-sm-8">@(selectedCustomerDetails.Phone ?? "-")</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Address:</dt>
                            <dd class="col-sm-8">@(selectedCustomerDetails.Address ?? "-")</dd>
                            
                            <dt class="col-sm-4">Created:</dt>
                            <dd class="col-sm-8">@selectedCustomerDetails.CreatedAt.ToShortDateString()</dd>
                        </dl>
                    </div>
                </div>
            }
            
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "sites" ? "active" : "")" 
                            type="button"
                            @onclick="@(() => SetActiveTab("sites"))"
                            role="tab">
                        <span class="bi bi-geo-alt"></span> Sites
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "systems" ? "active" : "")" 
                            type="button"
                            @onclick="@(() => SetActiveTab("systems"))"
                            role="tab">
                        <span class="bi bi-diagram-3"></span> Systems
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "orders" ? "active" : "")" 
                            type="button"
                            @onclick="@(() => SetActiveTab("orders"))"
                            role="tab">
                        <span class="bi bi-file-text"></span> Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "projects" ? "active" : "")" 
                            type="button"
                            @onclick="@(() => SetActiveTab("projects"))"
                            role="tab">
                        <span class="bi bi-kanban"></span> Projects
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(activeTab == "files" ? "active" : "")" 
                            type="button"
                            @onclick="@(() => SetActiveTab("files"))"
                            role="tab">
                        <span class="bi bi-file-earmark-arrow-up"></span> Files
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3">
                @if (activeTab == "sites")
                {
                    <SiteTab CustomerId="selectedCustomerDetails.Id" Sites="selectedCustomerDetails.Sites" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "systems")
                {
                    <SystemTab CustomerId="selectedCustomerDetails.Id" Systems="selectedCustomerDetails.Systems.OrderBy(s => s.SystemName).ToList()" Sites="selectedCustomerDetails.Sites" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "orders")
                {
                    <OrderTab CustomerId="selectedCustomerDetails.Id" Orders="selectedCustomerDetails.Orders" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "projects")
                {
                    <ProjectTab CustomerId="selectedCustomerDetails.Id" ProjectActivities="selectedCustomerDetails.ProjectActivities" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "files")
                {
                    <FileManager EntityType="Customer" EntityId="selectedCustomerDetails.Id" />
                }
            </div>
        </div>
    </div>
}

@code {
    private CustomerDto[]? customers;
    private CustomerDto? selectedCustomer;
    private CustomerWithChildrenDto? selectedCustomerDetails;
    private string activeTab = "sites";
    private string? deleteErrorMessage;
    
    private NewCustomerModel newCustomer = new();
    private EditContext? createEditContext;

    private EditCustomerModel editModel = new();
    private EditContext? editEditContext;
    private bool isEditing = false;
    
    // Create form visibility
    private bool showCreateForm = false;

    protected override async Task OnInitializedAsync()
    {
        Localizer.OnLanguageChanged += OnLanguageChanged;
        createEditContext = new EditContext(newCustomer);
        await LoadCustomersAsync();
        
        // Check for query parameters to auto-select customer and tab
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        var customerIdParam = query["customerId"];
        var tabParam = query["tab"];
        
        if (!string.IsNullOrEmpty(customerIdParam) && int.TryParse(customerIdParam, out int customerId))
        {
            await SelectCustomer(customerId);
            
            if (!string.IsNullOrEmpty(tabParam))
            {
                activeTab = tabParam;
            }
        }
    }

    private async Task LoadCustomersAsync()
    {
        customers = await CustomerApi.GetCustomersAsync();
    }

    private async Task SelectCustomer(int id)
    {
        selectedCustomer = customers?.FirstOrDefault(c => c.Id == id);
        deleteErrorMessage = null;
        await LoadCustomerDetails();
    }

    private void ClearSelection()
    {
        selectedCustomer = null;
        selectedCustomerDetails = null;
        isEditing = false;
        activeTab = "sites";
        deleteErrorMessage = null;
    }

    private async Task LoadCustomerDetails()
    {
        if (selectedCustomer != null)
        {
            try
            {
                selectedCustomerDetails = await CustomerApi.GetCustomerWithChildrenAsync(selectedCustomer.Id);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading customer details: {ex.Message}");
                selectedCustomerDetails = null;
                // Optionally show error message to user
            }
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private async Task CreateCustomerAsync()
    {
        var dto = new CustomerCreateDto(
            newCustomer.Name!,
            newCustomer.ContactPerson,
            newCustomer.Email,
            newCustomer.Phone,
            newCustomer.Address);

        var created = await CustomerApi.CreateCustomerAsync(dto);
        if (created != null)
        {
            newCustomer = new();
            createEditContext = new EditContext(newCustomer);
            showCreateForm = false;
            await LoadCustomersAsync();
        }
    }

    private void StartEdit()
    {
        if (selectedCustomerDetails != null)
        {
            isEditing = true;
            editModel = new EditCustomerModel
            {
                Id = selectedCustomerDetails.Id,
                Name = selectedCustomerDetails.Name,
                ContactPerson = selectedCustomerDetails.ContactPerson,
                Email = selectedCustomerDetails.Email,
                Phone = selectedCustomerDetails.Phone,
                Address = selectedCustomerDetails.Address
            };
            editEditContext = new EditContext(editModel);
        }
    }

    private async Task SaveEdit()
    {
        if (editModel.Id != 0)
        {
            var dto = new CustomerUpdateDto(
                editModel.Id,
                editModel.Name!,
                editModel.ContactPerson,
                editModel.Email,
                editModel.Phone,
                editModel.Address);

            await CustomerApi.UpdateCustomerAsync(dto);
            isEditing = false;
            await LoadCustomerDetails();
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
    }

    private async Task ConfirmDeleteCustomer(int id)
    {
        if (id == 0)
        {
            return;
        }

        var confirmationMessage = Localizer.GetString("DeleteCustomerConfirmation") ??
            "Are you sure you want to delete this customer?";

        if (await JS.InvokeAsync<bool>("confirm", confirmationMessage))
        {
            await DeleteCustomer(id);
        }
    }

    private async Task DeleteCustomer(int id)
    {
        if (id == 0)
        {
            return;
        }

        var response = await CustomerApi.DeleteCustomerAsync(id);
        if (response.IsSuccessStatusCode)
        {
            deleteErrorMessage = null;
            selectedCustomer = null;
            selectedCustomerDetails = null;
            await LoadCustomersAsync();
        }
        else
        {
            deleteErrorMessage = await GetDeleteErrorMessageAsync(response);
        }
    }

    private async Task<string> GetDeleteErrorMessageAsync(HttpResponseMessage response)
    {
        var content = await response.Content.ReadAsStringAsync();
        if (!string.IsNullOrWhiteSpace(content))
        {
            try
            {
                var errorResponse = JsonSerializer.Deserialize<ApiErrorResponse>(content);
                if (!string.IsNullOrWhiteSpace(errorResponse?.Message))
                {
                    return errorResponse.Message;
                }
            }
            catch (JsonException)
            {
                // Ignore parsing issues and fall back to raw content
            }

            return content;
        }

        return Localizer.GetString("DeleteCustomerFailed");
    }

    private record ApiErrorResponse(string? Message);

    class NewCustomerModel
    {
        [Required]
        public string? Name { get; set; }
        public string? ContactPerson { get; set; }
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public string? Address { get; set; }
    }

    class EditCustomerModel : NewCustomerModel
    {
        public int Id { get; set; }
    }

    public void Dispose()
    {
        Localizer.OnLanguageChanged -= OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }
}
