@page "/customers"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject CustomerApiClient CustomerApi
@inject NavigationManager Navigation

<PageTitle>Customers</PageTitle>

<h1>Customers</h1>

<div class="row mb-3">
    <div class="col-md-8">
        @if (customers == null)
        {
            <p><em>Loading customers...</em></p>
        }
        else if (customers.Length == 0)
        {
            <p class="text-muted">No customers found.</p>
        }
        else
        {
            <div class="list-group">
                @foreach (var customer in customers)
                {
                    <a href="#" class="list-group-item list-group-item-action @(selectedCustomer?.Id == customer.Id ? "active" : "")"
                       @onclick="() => SelectCustomer(customer.Id)" @onclick:preventDefault>
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">@customer.Name</h5>
                            <small>@customer.CreatedAt.ToShortDateString()</small>
                        </div>
                        @if (!string.IsNullOrEmpty(customer.ContactPerson))
                        {
                            <p class="mb-1"><small>Contact: @customer.ContactPerson</small></p>
                        }
                    </a>
                }
            </div>
        }
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Add New Customer</h5>
            </div>
            <div class="card-body">
                <EditForm EditContext="createEditContext" OnValidSubmit="CreateCustomerAsync" FormName="createCustomer">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="newCustomer.Name" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Person</label>
                        <InputText @bind-Value="newCustomer.ContactPerson" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <InputText @bind-Value="newCustomer.Email" class="form-control" type="email" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <InputText @bind-Value="newCustomer.Phone" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <InputTextArea @bind-Value="newCustomer.Address" class="form-control" rows="2" />
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Create Customer</button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@if (selectedCustomerDetails != null)
{
    <div class="card mt-4">
        <div class="card-header">
            <h4>@selectedCustomerDetails.Name</h4>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link @(activeTab == "databases" ? "active" : "")" 
                       @onclick="@(() => SetActiveTab("databases"))" 
                       @onclick:preventDefault
                       href="#">Databases</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(activeTab == "sites" ? "active" : "")" 
                       @onclick="@(() => SetActiveTab("sites"))" 
                       @onclick:preventDefault
                       href="#">Sites</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(activeTab == "systems" ? "active" : "")" 
                       @onclick="@(() => SetActiveTab("systems"))" 
                       @onclick:preventDefault
                       href="#">Systems</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link @(activeTab == "orders" ? "active" : "")" 
                       @onclick="@(() => SetActiveTab("orders"))" 
                       @onclick:preventDefault
                       href="#">Orders</a>
                </li>
            </ul>

            <div class="tab-content mt-3">
                @if (activeTab == "databases")
                {
                    <DatabaseTab CustomerId="selectedCustomerDetails.Id" Databases="selectedCustomerDetails.Databases" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "sites")
                {
                    <SiteTab CustomerId="selectedCustomerDetails.Id" Sites="selectedCustomerDetails.Sites" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "systems")
                {
                    <SystemTab CustomerId="selectedCustomerDetails.Id" Systems="selectedCustomerDetails.Systems" OnRefresh="LoadCustomerDetails" />
                }
                else if (activeTab == "orders")
                {
                    <OrderTab CustomerId="selectedCustomerDetails.Id" Orders="selectedCustomerDetails.Orders" OnRefresh="LoadCustomerDetails" />
                }
            </div>
        </div>
    </div>
}

@code {
    private CustomerDto[]? customers;
    private CustomerDto? selectedCustomer;
    private CustomerWithChildrenDto? selectedCustomerDetails;
    private string activeTab = "databases";
    
    private NewCustomerModel newCustomer = new();
    private EditContext? createEditContext;

    protected override async Task OnInitializedAsync()
    {
        createEditContext = new EditContext(newCustomer);
        await LoadCustomersAsync();
    }

    private async Task LoadCustomersAsync()
    {
        customers = await CustomerApi.GetCustomersAsync();
    }

    private async Task SelectCustomer(int id)
    {
        selectedCustomer = customers?.FirstOrDefault(c => c.Id == id);
        await LoadCustomerDetails();
    }

    private async Task LoadCustomerDetails()
    {
        if (selectedCustomer != null)
        {
            selectedCustomerDetails = await CustomerApi.GetCustomerWithChildrenAsync(selectedCustomer.Id);
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private async Task CreateCustomerAsync()
    {
        var dto = new CustomerCreateDto(
            newCustomer.Name!,
            newCustomer.ContactPerson,
            newCustomer.Email,
            newCustomer.Phone,
            newCustomer.Address);

        var created = await CustomerApi.CreateCustomerAsync(dto);
        if (created != null)
        {
            newCustomer = new();
            createEditContext = new EditContext(newCustomer);
            await LoadCustomersAsync();
        }
    }

    class NewCustomerModel
    {
        [Required]
        public string? Name { get; set; }
        public string? ContactPerson { get; set; }
        public string? Email { get; set; }
        public string? Phone { get; set; }
        public string? Address { get; set; }
    }
}
