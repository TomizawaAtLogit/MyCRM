@page "/projects"
@rendermode InteractiveServer
@inject ProjectsApiClient ProjectsApi
@inject CustomerApiClient CustomersApi
@inject OrderApiClient OrdersApi
@inject ProjectActivityApiClient ProjectActivityApi
@inject ProjectTaskApiClient ProjectTaskApi
@inject EntityFilesApiClient EntityFilesApi
@inject IJSRuntime JSRuntime
@inject LocalizationService Localizer
@inject AdminApiClient AdminApi
@inject NavigationManager Navigation
@using System.ComponentModel.DataAnnotations
@using System.Collections.Generic
@using AspireApp1.Web
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Forms
@implements IDisposable

<PageTitle>@Localizer.GetString("Projects")</PageTitle>

<PageAccessGuard PageName="Projects">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">@Localizer.GetString("Projects")</h1>
    <button class="btn btn-primary" @onclick="ShowCreateModal">
        <i class="bi bi-plus-circle me-2"></i>@Localizer.GetString("Create Project")
    </button>
</div>

@if (showToast && !string.IsNullOrEmpty(toastMessage))
{
    <div class="alert @(toastType == "success" ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @toastMessage
        <button type="button" class="btn-close" @onclick="() => showToast = false"></button>
    </div>
}

@if (showProjectDetailsModal && selectedProjectDetails != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer.GetString("Project Details") - @selectedProjectDetails.Name</h5>
                    <button type="button" class="btn-close" @onclick="HideProjectDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">@Localizer.GetString("Project ID"):</dt>
                                <dd class="col-sm-8">@selectedProjectDetails.Id</dd>
                                <dt class="col-sm-4">@Localizer.GetString("Customer"):</dt>
                                <dd class="col-sm-8">@selectedProjectDetails.CustomerName</dd>
                                <dt class="col-sm-4">@Localizer.GetString("Status"):</dt>
                                <dd class="col-sm-8">@Localizer.GetString(selectedProjectDetails.Status.ToString())</dd>
                                <dt class="col-sm-4">@Localizer.GetString("Created"):</dt>
                                <dd class="col-sm-8">@selectedProjectDetails.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            @if (!string.IsNullOrWhiteSpace(selectedProjectDetails.Description))
                            {
                                <div>
                                    <h6>@Localizer.GetString("Description")</h6>
                                    <p>@selectedProjectDetails.Description</p>
                                </div>
                            }
                            @if (selectedProjectDetails.CustomerOrderId.HasValue && selectedProjectDetails.CustomerOrderId > 0)
                            {
                                <div class="mt-3">
                                    <h6>@Localizer.GetString("Customer Order")</h6>
                                    @{
                                        var associatedOrder = GetAssociatedOrder(selectedProjectDetails.CustomerOrderId.Value);
                                        if (associatedOrder != null)
                                        {
                                            <dl class="row mb-0 small">
                                                <dt class="col-sm-5">@Localizer.GetString("Order Number"):</dt>
                                                <dd class="col-sm-7"><strong>@associatedOrder.OrderNumber</strong></dd>
                                                <dt class="col-sm-5">@Localizer.GetString("Contract Type"):</dt>
                                                <dd class="col-sm-7">@associatedOrder.ContractType</dd>
                                                <dt class="col-sm-5">@Localizer.GetString("Status"):</dt>
                                                <dd class="col-sm-7">
                                                    <span class="badge @GetStatusBadgeClass(associatedOrder.Status)">
                                                        @(associatedOrder.Status ?? Localizer.GetString("Unknown"))
                                                    </span>
                                                </dd>
                                            </dl>
                                        }
                                        else
                                        {
                                            <p class="text-muted mb-0">@Localizer.GetString("Order not found")</p>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">@Localizer.GetString("Activities")</h6>
                            @if (projectDetailsLoading)
                            {
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">@Localizer.GetString("Loading...")</span>
                                </div>
                            }
                        </div>
                        @if (projectDetailsLoading)
                        {
                            <div class="text-center py-2">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">@Localizer.GetString("Loading...")</span>
                                </div>
                                <p class="text-muted mb-0 mt-2">@Localizer.GetString("Loading activities...")</p>
                            </div>
                        }
                        else if (projectDetailsActivities != null && projectDetailsActivities.Any())
                        {
                            <div class="list-group">
                                @foreach (var activity in projectDetailsActivities)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between">
                                                <strong>@activity.Summary</strong>
                                                <small class="text-muted">@activity.ActivityDate.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</small>
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(activity.Description))
                                            {
                                                <p class="mb-1 text-muted">@activity.Description</p>
                                            }
                                            <small>
                                                @if (!string.IsNullOrWhiteSpace(activity.NextAction))
                                                {
                                                    <span>@Localizer.GetString("Next Action"): @activity.NextAction</span>
                                                    <br />
                                                }
                                                @if (!string.IsNullOrWhiteSpace(activity.PerformedBy))
                                                {
                                                    <span>@Localizer.GetString("Performed By"): @activity.PerformedBy</span>
                                                }
                                            </small>
                                        </div>
                                        <span class="text-muted ms-3"><i class="bi bi-chevron-right"></i></span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted mb-0">@Localizer.GetString("No activities yet.")</p>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="HideProjectDetailsModal">@Localizer.GetString("Close")</button>
                </div>
            </div>
        </div>
    </div>
}

<div class="row mb-3">
    <div class="col-md-12">
        <h5>@Localizer.GetString("Filters")</h5>
        <div class="row g-2">
            <div class="col-md-4">
                <label class="form-label">@Localizer.GetString("Customer")</label>
                <select class="form-select" value="@filterCustomerId" @onchange="OnCustomerFilterChanged">
                    <option value="">@Localizer.GetString("All Customers")</option>
                    @if (customers != null)
                    {
                        @foreach (var c in customers)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">@Localizer.GetString("Status")</label>
                <select class="form-select" value="@filterStatus" @onchange="OnStatusFilterChanged">
                    <option value="">@Localizer.GetString("All Statuses")</option>
                    <option value="Wip">WIP</option>
                    <option value="Pending">Pending</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <h4>@Localizer.GetString("Existing Projects")</h4>
        @if (!string.IsNullOrEmpty(loadError))
        {
            <div class="alert alert-warning">Unable to load projects: @loadError</div>
        }
        else if (projects is null)
        {
            <p><em>@Localizer.GetString("Loading...")</em></p>
        }
        else if (projects.Length == 0)
        {
            <p class="text-muted">@Localizer.GetString("No projects.")</p>
        }
        else
        {
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>
                            <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(ProjectsSortColumn.Name)" aria-label="Sort by name">
                                <span>@Localizer.GetString("Name")</span>
                                <span class="sort-indicator text-muted small">@GetSortIndicator(ProjectsSortColumn.Name)</span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(ProjectsSortColumn.Customer)" aria-label="Sort by customer">
                                <span>@Localizer.GetString("Customer")</span>
                                <span class="sort-indicator text-muted small">@GetSortIndicator(ProjectsSortColumn.Customer)</span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(ProjectsSortColumn.Status)" aria-label="Sort by status">
                                <span>@Localizer.GetString("Status")</span>
                                <span class="sort-indicator text-muted small">@GetSortIndicator(ProjectsSortColumn.Status)</span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="btn btn-link text-decoration-none text-dark p-0 d-flex align-items-center gap-1" @onclick="() => SetSortColumn(ProjectsSortColumn.Created)" aria-label="Sort by created date">
                                <span>@Localizer.GetString("Created")</span>
                                <span class="sort-indicator text-muted small">@GetSortIndicator(ProjectsSortColumn.Created)</span>
                            </button>
                        </th>
                        <th>@Localizer.GetString("Actions")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in projects)
                    {
                        <tr>
                            <td style="vertical-align: middle;">
                                <button class="btn btn-link btn-chevron" @onclick="() => ToggleProjectExpansionAsync(p.Id)">
                                    <i class="bi @(expandedProjects.ContainsKey(p.Id) && expandedProjects[p.Id] ? "bi-chevron-down" : "bi-chevron-right")"></i>
                                </button>
                            </td>
                            <td>
                                <strong>@p.Name</strong>
                                @if (!string.IsNullOrWhiteSpace(p.Description))
                                {
                                    <div class="small text-muted">@p.Description</div>
                                }
                            </td>
                            <td>@p.CustomerName</td>
                            <td>
                                @if (p.Status == ProjectStatus.Wip)
                                {
                                    <span class="badge bg-primary">WIP</span>
                                }
                                else if (p.Status == ProjectStatus.Pending)
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else if (p.Status == ProjectStatus.Closed)
                                {
                                    <span class="badge bg-secondary">Closed</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@p.Status</span>
                                }
                            </td>
                            <td class="small">@p.CreatedAt.ToLocalTime().ToString("g")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEdit(p)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info me-1" type="button" @onclick="async () => await ShowProjectDetailsAsync(p)" aria-label='@Localizer.GetString("View Project Details")'>
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProjectAsync(p.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        
                        @* Nested activities section *@
                        @if (expandedProjects.ContainsKey(p.Id) && expandedProjects[p.Id])
                        {
                            <tr>
                                <td colspan="6" class="ps-5" style="background-color: var(--bg-secondary);">
                                    @* Project detail tabs *@
                                    <div class="py-3">
                                        <ul class="nav nav-tabs mb-3" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(GetProjectTab(p.Id) == "activities" ? "active" : "")" 
                                                        type="button"
                                                        @onclick="@(() => SetProjectTab(p.Id, "activities"))"
                                                        role="tab">
                                                    <span class="bi bi-calendar-event"></span> @Localizer.GetString("Issue")
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(GetProjectTab(p.Id) == "gantt" ? "active" : "")" 
                                                        type="button"
                                                        @onclick="@(() => SetProjectTabAsync(p.Id, "gantt"))"
                                                        role="tab">
                                                    <span class="bi bi-bar-chart-steps"></span> @Localizer.GetString("Scheduled Task")
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(GetProjectTab(p.Id) == "files" ? "active" : "")" 
                                                        type="button"
                                                        @onclick="@(() => SetProjectTab(p.Id, "files"))"
                                                        role="tab">
                                                    <span class="bi bi-file-earmark-arrow-up"></span> Files
                                                </button>
                                            </li>
                                        </ul>

                                        @{ var projectTab = GetProjectTab(p.Id); }

                                        @if (projectTab == "activities")
                                        {
                                            if (loadingActivities.ContainsKey(p.Id) && loadingActivities[p.Id])
                                            {
                                                <div class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <span class="ms-2">Loading activities...</span>
                                                </div>
                                            }
                                            else if (!projectActivities.ContainsKey(p.Id) || projectActivities[p.Id] == null || !projectActivities[p.Id]!.Any())
                                            {
                                                <div class="py-3">
                                                    <p class="text-muted mb-2">No activities yet.</p>

                                                    @if (!showAddActivity.ContainsKey(p.Id) || !showAddActivity[p.Id])
                                                    {
                                                        <button class="btn btn-sm btn-primary" @onclick="async () => await ShowAddActivityFormAsync(p.Id)" disabled="@(currentEditingActivityId != null)">
                                                            <i class="bi bi-plus-circle me-1"></i> @Localizer.GetString("Add New Activity")
                                                        </button>
                                                    }
                                                    else if (newActivityModels.ContainsKey(p.Id) && activityCreateContexts.ContainsKey(p.Id))
                                                    {
                                                        var model = newActivityModels[p.Id];
                                                        var context = activityCreateContexts[p.Id];
                                                        <div class="card mt-2">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <h6 class="mb-0">@Localizer.GetString("New Activity")</h6>
                                                                <button class="btn btn-sm btn-secondary" @onclick="() => HideAddActivityForm(p.Id)">@Localizer.GetString("Cancel")</button>
                                                            </div>
                                                            <div class="card-body">
                                                                <EditForm EditContext="@context" OnValidSubmit="() => CreateActivityAsync(p.Id)">
                                                                    <DataAnnotationsValidator />
                                                                    <ValidationSummary />
                                                                    <div class="row">
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Activity Date") *</label>
                                                                            <InputDate @bind-Value="model.ActivityDate" class="form-control" />
                                                                            <ValidationMessage For="() => model.ActivityDate" />
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Task") *</label>
                                                                            <InputText @bind-Value="model.Summary" class="form-control" />
                                                                            <ValidationMessage For="() => model.Summary" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">@Localizer.GetString("Description")</label>
                                                                        <InputTextArea @bind-Value="model.Description" class="form-control" rows="3" />
                                                                        <ValidationMessage For="() => model.Description" />
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">@Localizer.GetString("Next Action")</label>
                                                                        <InputTextArea @bind-Value="model.NextAction" class="form-control" rows="2" />
                                                                        <ValidationMessage For="() => model.NextAction" />
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Note")</label>
                                                                            <InputText @bind-Value="model.ActivityType" class="form-control" />
                                                                            <ValidationMessage For="() => model.ActivityType" />
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Performed By")</label>
                                                                            <InputSelect @bind-Value="model.PerformedBy" class="form-select">
                                                                                <option value="">@Localizer.GetString("Select User")</option>
                                                                                @if (users != null)
                                                                                {
                                                                                    @foreach (var u in users.Where(u => u.IsActive))
                                                                                    {
                                                                                        <option value="@u.DisplayName">@u.DisplayName</option>
                                                                                    }
                                                                                }
                                                                            </InputSelect>
                                                                            <ValidationMessage For="() => model.PerformedBy" />
                                                                        </div>
                                                                    </div>
                                                                    <button class="btn btn-primary w-100" type="submit">@Localizer.GetString("Create Activity")</button>
                                                                </EditForm>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="py-3">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <h6 class="mb-0">@Localizer.GetString("Issue")</h6>
                                                        @if (!showAddActivity.ContainsKey(p.Id) || !showAddActivity[p.Id])
                                                        {
                                                            <button class="btn btn-sm btn-primary" @onclick="async () => await ShowAddActivityFormAsync(p.Id)" disabled="@(currentEditingActivityId != null)">
                                                                <i class="bi bi-plus-circle me-1"></i> @Localizer.GetString("Add New Activity")
                                                            </button>
                                                        }
                                                    </div>

                                                    @if (showAddActivity.ContainsKey(p.Id) && showAddActivity[p.Id] && newActivityModels.ContainsKey(p.Id) && activityCreateContexts.ContainsKey(p.Id))
                                                    {
                                                        var model = newActivityModels[p.Id];
                                                        var context = activityCreateContexts[p.Id];
                                                        <div class="card mb-3">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <h6 class="mb-0">@Localizer.GetString("New Activity")</h6>
                                                                <button class="btn btn-sm btn-secondary" @onclick="() => HideAddActivityForm(p.Id)">@Localizer.GetString("Cancel")</button>
                                                            </div>
                                                            <div class="card-body">
                                                                <EditForm EditContext="@context" OnValidSubmit="() => CreateActivityAsync(p.Id)">
                                                                    <DataAnnotationsValidator />
                                                                    <ValidationSummary />
                                                                    <div class="row">
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Activity Date") *</label>
                                                                            <InputDate @bind-Value="model.ActivityDate" class="form-control" />
                                                                            <ValidationMessage For="() => model.ActivityDate" />
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Task") *</label>
                                                                            <InputText @bind-Value="model.Summary" class="form-control" />
                                                                            <ValidationMessage For="() => model.Summary" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">@Localizer.GetString("Description")</label>
                                                                        <InputTextArea @bind-Value="model.Description" class="form-control" rows="3" />
                                                                        <ValidationMessage For="() => model.Description" />
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">@Localizer.GetString("Next Action")</label>
                                                                        <InputTextArea @bind-Value="model.NextAction" class="form-control" rows="2" />
                                                                        <ValidationMessage For="() => model.NextAction" />
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Note")</label>
                                                                            <InputText @bind-Value="model.ActivityType" class="form-control" />
                                                                            <ValidationMessage For="() => model.ActivityType" />
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Performed By")</label>
                                                                            <InputSelect @bind-Value="model.PerformedBy" class="form-select">
                                                                                <option value="">@Localizer.GetString("Select User")</option>
                                                                                @if (users != null)
                                                                                {
                                                                                    @if (!string.IsNullOrEmpty(model.PerformedBy) && !users.Any(u => u.IsActive && u.DisplayName == model.PerformedBy))
                                                                                    {
                                                                                        <option value="@model.PerformedBy">@model.PerformedBy (Inactive)</option>
                                                                                    }
                                                                                    @foreach (var u in users.Where(u => u.IsActive))
                                                                                    {
                                                                                        <option value="@u.DisplayName">@u.DisplayName</option>
                                                                                    }
                                                                                }
                                                                            </InputSelect>
                                                                            <ValidationMessage For="() => model.PerformedBy" />
                                                                        </div>
                                                                    </div>
                                                                    <button class="btn btn-primary w-100" type="submit">@Localizer.GetString("Create Activity")</button>
                                                                </EditForm>
                                                            </div>
                                                        </div>
                                                    }

                                                    <table class="table table-sm table-hover project-issues-table">
                                                        <thead>
                                                            <tr>
                                                                <th>@Localizer.GetString("Date")</th>
                                                                <th>@Localizer.GetString("Task")</th>
                                                                <th>@Localizer.GetString("Description")</th>
                                                                <th>@Localizer.GetString("Next Action")</th>
                                                                <th>@Localizer.GetString("Note")</th>
                                                                <th>@Localizer.GetString("Performed By")</th>
                                                                <th>@Localizer.GetString("Actions")</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var activity in projectActivities[p.Id]!)
                                                            {
                                                                <tr>
                                                                    <td class="small">@activity.ActivityDate.ToLocalTime().ToString("g")</td>
                                                                    <td>@activity.Summary</td>
                                                                    <td class="small description-cell">@activity.Description</td>
                                                                    <td class="small">@activity.NextAction</td>
                                                                    <td class="small">@activity.ActivityType</td>
                                                                    <td class="small">@activity.PerformedBy</td>
                                                                    <td>
                                                                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEditActivity(p.Id, activity)">
                                                                            <i class="bi bi-pencil"></i>
                                                                        </button>
                                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteActivityAsync(p.Id, activity.Id)">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>

                                                                @if (currentEditingActivityId == activity.Id && currentEditingProjectId == p.Id && editActivityModel != null)
                                                                {
                                                                    <tr>
                                                                        <td colspan="7" class="border-top-0">
                                                                            <div class="card mt-2 mb-3">
                                                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                                                    <h6 class="mb-0">@Localizer.GetString("Edit Activity")</h6>
                                                                                    <button class="btn btn-sm btn-secondary" @onclick="CancelEditActivity">@Localizer.GetString("Cancel")</button>
                                                                                </div>
                                                                                <div class="card-body">
                                                                                    <EditForm Model="editActivityModel" OnValidSubmit="SaveEditActivityAsync">
                                                                                        <DataAnnotationsValidator />
                                                                                        <ValidationSummary />
                                                                                        <div class="row">
                                                                                            <div class="col-md-6 mb-3">
                                                                                                <label class="form-label">@Localizer.GetString("Activity Date") *</label>
                                                                                                <InputDate @bind-Value="editActivityModel.ActivityDate" class="form-control" />
                                                                                                <ValidationMessage For="() => editActivityModel.ActivityDate" />
                                                                                            </div>
                                                                                            <div class="col-md-6 mb-3">
                                                                                                <label class="form-label">@Localizer.GetString("Task") *</label>
                                                                                                <InputText @bind-Value="editActivityModel.Summary" class="form-control" />
                                                                                                <ValidationMessage For="() => editActivityModel.Summary" />
                                                                                            </div>
                                                                                        </div>
                                                                                        <div class="mb-3">
                                                                                            <label class="form-label">@Localizer.GetString("Description")</label>
                                                                                            <InputTextArea @bind-Value="editActivityModel.Description" class="form-control" rows="3" />
                                                                                            <ValidationMessage For="() => editActivityModel.Description" />
                                                                                        </div>
                                                                                        <div class="mb-3">
                                                                                            <label class="form-label">@Localizer.GetString("Next Action")</label>
                                                                                            <InputTextArea @bind-Value="editActivityModel.NextAction" class="form-control" rows="2" />
                                                                                            <ValidationMessage For="() => editActivityModel.NextAction" />
                                                                                        </div>
                                                                                        <div class="row">
                                                                                            <div class="col-md-6 mb-3">
                                                                                                <label class="form-label">@Localizer.GetString("Note")</label>
                                                                                                <InputText @bind-Value="editActivityModel.ActivityType" class="form-control" />
                                                                                                <ValidationMessage For="() => editActivityModel.ActivityType" />
                                                                                            </div>
                                                                                            <div class="col-md-6 mb-3">
                                                                                                <label class="form-label">@Localizer.GetString("Performed By")</label>
                                                                                                <InputSelect @bind-Value="editActivityModel.PerformedBy" class="form-select">
                                                                                                    <option value="">@Localizer.GetString("Select User")</option>
                                                                                                    @if (users != null)
                                                                                                    {
                                                                                                        @if (!string.IsNullOrEmpty(editActivityModel.PerformedBy) && !users.Any(u => u.IsActive && u.DisplayName == editActivityModel.PerformedBy))
                                                                                                        {
                                                                                                            <option value="@editActivityModel.PerformedBy">@editActivityModel.PerformedBy (Inactive)</option>
                                                                                                        }
                                                                                                        @foreach (var u in users.Where(u => u.IsActive))
                                                                                                        {
                                                                                                            <option value="@u.DisplayName">@u.DisplayName</option>
                                                                                                        }
                                                                                                    }
                                                                                                </InputSelect>
                                                                                                <ValidationMessage For="() => editActivityModel.PerformedBy" />
                                                                                            </div>
                                                                                        </div>
                                                                                        <div class="d-flex gap-2">
                                                                                            <button class="btn btn-primary" type="submit">@Localizer.GetString("Save Changes")</button>
                                                                                            <button class="btn btn-secondary" type="button" @onclick="CancelEditActivity">@Localizer.GetString("Cancel")</button>
                                                                                        </div>
                                                                                    </EditForm>
                                                                                </div>
                                                                            </div>
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            }
                                        }
                                        else if (projectTab == "gantt")
                                        {
                                            @if (loadingTasks.ContainsKey(p.Id) && loadingTasks[p.Id])
                                            {
                                                    <div class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <span class="ms-2">@Localizer.GetString("Loading tasks...")</span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="py-3">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <h6 class="mb-0">@Localizer.GetString("Scheduled Task")</h6>
                                                            <a class="btn btn-sm btn-outline-info" href="@GetProjectCalendarLink(p)">
                                                                <i class="bi bi-calendar3 me-1"></i> @Localizer.GetString("View on Calendar")
                                                            </a>
                                                        </div>
                                                        @if (!showAddTask.ContainsKey(p.Id) || !showAddTask[p.Id])
                                                        {
                                                            <button class="btn btn-sm btn-primary" @onclick="() => ShowAddTaskForm(p.Id)">
                                                                <i class="bi bi-plus-circle me-1"></i> @Localizer.GetString("Add Task")
                                                            </button>
                                                        }
                                                    </div>

                                                    @if (showAddTask.ContainsKey(p.Id) && showAddTask[p.Id])
                                                    {
                                                        <div class="card mb-3">
                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                <h6 class="mb-0">@Localizer.GetString("New Task")</h6>
                                                                <button class="btn btn-sm btn-secondary" @onclick="() => HideAddTaskForm(p.Id)">@Localizer.GetString("Cancel")</button>
                                                            </div>
                                                            <div class="card-body">
                                                                <EditForm Model="newTaskModel" OnValidSubmit="() => CreateTaskAsync(p.Id)">
                                                                    <DataAnnotationsValidator />
                                                                    <ValidationSummary />
                                                                    <div class="row">
                                                                        <div class="col-md-12 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Title") *</label>
                                                                            <InputText @bind-Value="newTaskModel.Title" class="form-control" />
                                                                            <ValidationMessage For="() => newTaskModel.Title" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">@Localizer.GetString("Description")</label>
                                                                        <InputTextArea @bind-Value="newTaskModel.Description" class="form-control" rows="2" />
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("Start Date") *</label>
                                                                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="newTaskModel.StartDate" class="form-control" />
                                                                            <ValidationMessage For="() => newTaskModel.StartDate" />
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                            <label class="form-label">@Localizer.GetString("End Date") *</label>
                                                                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="newTaskModel.EndDate" class="form-control" />
                                                                            <ValidationMessage For="() => newTaskModel.EndDate" />
                                                                        </div>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label class="form-label">@Localizer.GetString("Status")</label>
                                                                        <InputSelect @bind-Value="newTaskModel.Status" class="form-select">
                                                                            <option value="@ProjectTaskStatus.NotStarted">@Localizer.GetString("Not Started")</option>
                                                                            <option value="@ProjectTaskStatus.InProgress">@Localizer.GetString("In Progress")</option>
                                                                            <option value="@ProjectTaskStatus.Completed">@Localizer.GetString("Completed")</option>
                                                                            <option value="@ProjectTaskStatus.Blocked">@Localizer.GetString("Blocked")</option>
                                                                        </InputSelect>
                                                                    </div>
                                                                    <button class="btn btn-primary w-100" type="submit">@Localizer.GetString("Create Task")</button>
                                                                </EditForm>
                                                            </div>
                                                        </div>
                                                    }

                                                    @if (!projectTasks.ContainsKey(p.Id) || projectTasks[p.Id] == null || !projectTasks[p.Id]!.Any())
                                                    {
                                                        <p class="text-muted">@Localizer.GetString("No tasks yet.")</p>
                                                    }
                                                    else
                                                    {
                                                        <div class="gantt-container mb-3">
                                                            <div class="gantt-header">
                                                                <div class="row">
                                                                    <div class="col-md-3 fw-bold">@Localizer.GetString("Task")</div>
                                                                    <div class="col-md-2 fw-bold">@Localizer.GetString("Status")</div>
                                                                    <div class="col-md-5 fw-bold">@Localizer.GetString("Timeline")</div>
                                                                    <div class="col-md-2 fw-bold">@Localizer.GetString("Actions")</div>
                                                                </div>
                                                            </div>
                                                            @foreach (var task in projectTasks[p.Id]!)
                                                            {
                                                                <div class="gantt-row">
                                                                    <div class="row align-items-center">
                                                                        <div class="col-md-3">
                                                                            <strong>@task.Title</strong>
                                                                            @if (!string.IsNullOrWhiteSpace(task.Description))
                                                                            {
                                                                                <div class="small text-muted">@task.Description</div>
                                                                            }
                                                                        </div>
                                                                        <div class="col-md-2">
                                                                            @if (task.Status == ProjectTaskStatus.NotStarted)
                                                                            {
                                                                                <span class="badge bg-secondary">@Localizer.GetString("Not Started")</span>
                                                                            }
                                                                            else if (task.Status == ProjectTaskStatus.InProgress)
                                                                            {
                                                                                <span class="badge bg-primary">@Localizer.GetString("In Progress")</span>
                                                                            }
                                                                            else if (task.Status == ProjectTaskStatus.Completed)
                                                                            {
                                                                                <span class="badge bg-success">@Localizer.GetString("Completed")</span>
                                                                            }
                                                                            else if (task.Status == ProjectTaskStatus.Blocked)
                                                                            {
                                                                                <span class="badge bg-danger">@Localizer.GetString("Blocked")</span>
                                                                            }
                                                                        </div>
                                                                        <div class="col-md-5">
                                                                            <div class="small">
                                                                                <strong>@Localizer.GetString("Start"):</strong> @task.StartAtUtc.ToLocalTime().ToString("g")<br/>
                                                                                <strong>@Localizer.GetString("End"):</strong> @task.EndAtUtc.ToLocalTime().ToString("g")
                                                                            </div>
                                                                            <div class="progress mt-1" style="height: 20px;">
                                                                                @{
                                                                                    var startDate = task.StartAtUtc.ToLocalTime();
                                                                                    var endDate = task.EndAtUtc.ToLocalTime();
                                                                                    var duration = (endDate - startDate).TotalDays;
                                                                                    var progressClass = task.Status switch
                                                                                    {
                                                                                        ProjectTaskStatus.NotStarted => "bg-secondary",
                                                                                        ProjectTaskStatus.InProgress => "bg-primary",
                                                                                        ProjectTaskStatus.Completed => "bg-success",
                                                                                        ProjectTaskStatus.Blocked => "bg-danger",
                                                                                        _ => "bg-secondary"
                                                                                    };
                                                                                }
                                                                                <div class="progress-bar @progressClass" role="progressbar" style="width: 100%;">
                                                                                    @(duration > 0 ? $"{duration:F1} days" : "< 1 day")
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-2">
                                                                            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEditTask(p.Id, task)">
                                                                                <i class="bi bi-pencil"></i>
                                                                            </button>
                                                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTaskAsync(p.Id, task.Id)">
                                                                                <i class="bi bi-trash"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>

                                                                    @* Inline edit form for task *@
                                                                    @if (currentEditingTaskId == task.Id && currentEditingProjectId == p.Id && editTaskModel != null)
                                                                    {
                                                                        <div class="card mt-2 mb-2">
                                                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                                                <h6 class="mb-0">@Localizer.GetString("Edit Task")</h6>
                                                                                <button class="btn btn-sm btn-secondary" @onclick="CancelEditTask">@Localizer.GetString("Cancel")</button>
                                                                            </div>
                                                                            <div class="card-body">
                                                                                <EditForm Model="editTaskModel" OnValidSubmit="SaveEditTaskAsync">
                                                                                    <DataAnnotationsValidator />
                                                                                    <ValidationSummary />
                                                                                    <div class="row">
                                                                                        <div class="col-md-12 mb-3">
                                                                                            <label class="form-label">@Localizer.GetString("Title") *</label>
                                                                                            <InputText @bind-Value="editTaskModel.Title" class="form-control" />
                                                                                            <ValidationMessage For="() => editTaskModel.Title" />
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label class="form-label">@Localizer.GetString("Description")</label>
                                                                                        <InputTextArea @bind-Value="editTaskModel.Description" class="form-control" rows="2" />
                                                                                    </div>
                                                                                    <div class="row">
                                                                                        <div class="col-md-6 mb-3">
                                                                                            <label class="form-label">@Localizer.GetString("Start Date") *</label>
                                                                                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editTaskModel.StartDate" class="form-control" />
                                                                                            <ValidationMessage For="() => editTaskModel.StartDate" />
                                                                                        </div>
                                                                                        <div class="col-md-6 mb-3">
                                                                                            <label class="form-label">@Localizer.GetString("End Date") *</label>
                                                                                            <InputDate Type="InputDateType.DateTimeLocal" @bind-Value="editTaskModel.EndDate" class="form-control" />
                                                                                            <ValidationMessage For="() => editTaskModel.EndDate" />
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="mb-3">
                                                                                        <label class="form-label">@Localizer.GetString("Status")</label>
                                                                                        <InputSelect @bind-Value="editTaskModel.Status" class="form-select">
                                                                                            <option value="@ProjectTaskStatus.NotStarted">@Localizer.GetString("Not Started")</option>
                                                                                            <option value="@ProjectTaskStatus.InProgress">@Localizer.GetString("In Progress")</option>
                                                                                            <option value="@ProjectTaskStatus.Completed">@Localizer.GetString("Completed")</option>
                                                                                            <option value="@ProjectTaskStatus.Blocked">@Localizer.GetString("Blocked")</option>
                                                                                        </InputSelect>
                                                                                    </div>
                                                                                    <div class="d-flex gap-2">
                                                                                        <button class="btn btn-primary" type="submit">@Localizer.GetString("Save Changes")</button>
                                                                                        <button class="btn btn-secondary" type="button" @onclick="CancelEditTask">@Localizer.GetString("Cancel")</button>
                                                                                    </div>
                                                                                </EditForm>
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <FileManager EntityType="Project" EntityId="p.Id" />
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@* Create Project Modal *@
@if (showCreateModal)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@Localizer.GetString("Create Project")</h5>
                    <button type="button" class="btn-close" @onclick="HideCreateModal"></button>
                </div>
                <EditForm EditContext="createEditContext" OnValidSubmit="CreateAsync" FormName="createForm">
                    <div class="modal-body">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <!-- Row 1: Name -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">@Localizer.GetString("Name") *</label>
                                <InputText @bind-Value="newProject!.Name" class="form-control" />
                                <ValidationMessage For="() => newProject!.Name" />
                            </div>
                        </div>
                        <!-- Row 2: Description -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">@Localizer.GetString("Description")</label>
                                <InputTextArea @bind-Value="newProject.Description" class="form-control" rows="3" />
                            </div>
                        </div>
                        <!-- Row 3: Customer and Customer Order (side by side) -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Customer") *</label>
                                <InputSelect @bind-Value="newProject.CustomerId" @bind-Value:after="OnNewProjectCustomerChanged" class="form-select">
                                    <option value="0">-- Select Customer --</option>
                                    @if (customers != null)
                                    {
                                        @foreach (var c in customers)
                                        {
                                            <option value="@c.Id">@c.Name</option>
                                        }
                                    }
                                </InputSelect>
                                <ValidationMessage For="() => newProject.CustomerId" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Customer Order")</label>
                                <InputSelect TValue="int?" @bind-Value="newProject.CustomerOrderId" class="form-select" disabled="@(newProject.CustomerId == 0)">
                                    <option value="">-- @Localizer.GetString("None") --</option>
                                    @if (filteredOrders != null)
                                    {
                                        @foreach (var order in filteredOrders)
                                        {
                                            <option value="@order.Id">@order.OrderNumber - @order.ContractType</option>
                                        }
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        <!-- Row 4: Status -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">@Localizer.GetString("Status")</label>
                                <InputSelect @bind-Value="newProject.Status" class="form-select">
                                    <option value="@ProjectStatus.Wip">WIP</option>
                                    <option value="@ProjectStatus.Pending">Pending</option>
                                    <option value="@ProjectStatus.Closed">Closed</option>
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-end gap-2">
                        <button class="btn btn-secondary" type="button" @onclick="HideCreateModal">Cancel</button>
                        <button class="btn btn-primary" type="submit">@Localizer.GetString("Create Project")</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@* Edit Project Modal *@
@if (isEditing)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Project</h5>
                    <button type="button" class="btn-close" @onclick="CancelEdit"></button>
                </div>
                <EditForm EditContext="editEditContext" OnValidSubmit="SaveEditAsync">
                    <div class="modal-body">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <input type="hidden" @bind="editModel!.Id" />
                        <!-- Row 1: Name -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">@Localizer.GetString("Name") *</label>
                                <InputText @bind-Value="editModel!.Name" class="form-control" />
                                <ValidationMessage For="() => editModel!.Name" />
                            </div>
                        </div>
                        <!-- Row 2: Description -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">@Localizer.GetString("Description")</label>
                                <InputTextArea @bind-Value="editModel!.Description" class="form-control" rows="3" />
                            </div>
                        </div>
                        <!-- Row 3: Customer and Customer Order (side by side) -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Customer") *</label>
                                <InputSelect @bind-Value="editModel.CustomerId" @bind-Value:after="OnEditProjectCustomerChanged" class="form-select">
                                    <option value="0">-- Select Customer --</option>
                                    @if (customers != null)
                                    {
                                        @foreach (var c in customers)
                                        {
                                            <option value="@c.Id">@c.Name</option>
                                        }
                                    }
                                </InputSelect>
                                <ValidationMessage For="() => editModel!.CustomerId" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">@Localizer.GetString("Customer Order")</label>
                                <InputSelect TValue="int?" @bind-Value="editModel.CustomerOrderId" class="form-select" disabled="@(editModel.CustomerId == 0)">
                                    <option value="">-- @Localizer.GetString("None") --</option>
                                    @if (filteredOrders != null)
                                    {
                                        @foreach (var order in filteredOrders)
                                        {
                                            <option value="@order.Id">@order.OrderNumber - @order.ContractType</option>
                                        }
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        <!-- Row 4: Status -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">@Localizer.GetString("Status")</label>
                                <InputSelect @bind-Value="editModel.Status" class="form-select">
                                    <option value="@ProjectStatus.Wip">WIP</option>
                                    <option value="@ProjectStatus.Pending">Pending</option>
                                    <option value="@ProjectStatus.Closed">Closed</option>
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-end gap-2">
                        <button class="btn btn-secondary" type="button" @onclick="CancelEdit">Cancel</button>
                        <button class="btn btn-primary" type="submit">Save Changes</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

</PageAccessGuard>

@code {
    private Web.ProjectDto[]? projects;
    private Web.CustomerDto[]? customers;
    private Web.UserDto[]? users;
    private OrderWithCustomerDto[]? allOrders;
    private OrderWithCustomerDto[]? filteredOrders;
    private string? loadError;
    private string filterCustomerId = "";
    private string filterStatus = "";
    
    // Sorting
    private ProjectsSortColumn sortColumn = ProjectsSortColumn.Created;
    private bool sortDescending = true;
    
    [SupplyParameterFromForm]
    private NewModel? newProject { get; set; }
    
    [SupplyParameterFromForm]
    private EditModel? editModel { get; set; }
    
    private bool isEditing;
    private EditContext? createEditContext;
    private EditContext? editEditContext;
    
    // Activity state management
    private Dictionary<int, bool> expandedProjects = new();
    private Dictionary<int, List<ProjectActivityDto>?> projectActivities = new();
    private Dictionary<int, bool> loadingActivities = new();
    private Dictionary<int, bool> showAddActivity = new();
    private Dictionary<int, string> projectActiveTabs = new();  // Track active tab per project
    
    // Task state management
    private Dictionary<int, List<ProjectTaskDto>?> projectTasks = new();
    private Dictionary<int, bool> loadingTasks = new();
    private Dictionary<int, bool> showAddTask = new();
    private int? currentEditingTaskId;
    private NewTaskModel newTaskModel = new();
    private EditTaskModel? editTaskModel;
    
    // Single edit tracking
    private int? currentEditingProjectId;
    private int? currentEditingActivityId;
    private EditActivityModel? editActivityModel;
    
    // Activity form models
    private Dictionary<int, NewActivityModel> newActivityModels = new();
    private Dictionary<int, EditContext> activityCreateContexts = new();
    
    // Toast state
    private string? toastMessage;
    private string? toastType;
    private bool showToast;
    
    // Modal visibility
    private bool showCreateModal = false;
    private bool showProjectDetailsModal = false;
    private ProjectDto? selectedProjectDetails;
    private List<ProjectActivityDto>? projectDetailsActivities;
    private bool projectDetailsLoading;

    // Query-driven project highlighting
    private int? highlightProjectIdFromQuery;
    private string? highlightProjectTabFromQuery;
    private bool highlightProjectApplied;

    protected override async Task OnInitializedAsync()
    {
        Localizer.OnLanguageChanged += OnLanguageChanged;
        ParseProjectQueryParameters();
        newProject ??= new();
        editModel ??= new();
        createEditContext = new EditContext(newProject);
        editEditContext = new EditContext(editModel);
        await LoadCustomersAsync();
        await LoadAsync();
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            customers = await CustomersApi.GetCustomersAsync();
            users = await AdminApi.GetUsersAsync();
            allOrders = await OrdersApi.GetOrdersAsync();
        }
        catch
        {
            customers = Array.Empty<CustomerDto>();
            users = Array.Empty<UserDto>();
            allOrders = Array.Empty<OrderWithCustomerDto>();
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            int? customerId = string.IsNullOrEmpty(filterCustomerId) ? null : int.Parse(filterCustomerId);
            ProjectStatus? status = string.IsNullOrEmpty(filterStatus) ? null : Enum.Parse<ProjectStatus>(filterStatus);
            projects = await ProjectsApi.GetProjectsAsync(customerId, status);
            loadError = null;
            await ApplyHighlightedProjectAsync();
            ApplySorting();
        }
        catch (Exception ex)
        {
            projects = Array.Empty<ProjectDto>();
            loadError = ex.Message;
        }
    }

    private async Task ApplyFiltersAsync()
    {
        await LoadAsync();
        ApplySorting();
    }

    private void SetSortColumn(ProjectsSortColumn column)
    {
        if (sortColumn == column)
        {
            sortDescending = !sortDescending;
        }
        else
        {
            sortColumn = column;
            sortDescending = false;
        }

        ApplySorting();
    }

    private void ApplySorting()
    {
        if (projects == null || projects.Length == 0) return;

        projects = sortColumn switch
        {
            ProjectsSortColumn.Name => sortDescending
                ? projects.OrderByDescending(p => p.Name).ToArray()
                : projects.OrderBy(p => p.Name).ToArray(),
            ProjectsSortColumn.Customer => sortDescending
                ? projects.OrderByDescending(p => p.CustomerName).ToArray()
                : projects.OrderBy(p => p.CustomerName).ToArray(),
            ProjectsSortColumn.Status => sortDescending
                ? projects.OrderByDescending(p => p.Status).ToArray()
                : projects.OrderBy(p => p.Status).ToArray(),
            ProjectsSortColumn.Created => sortDescending
                ? projects.OrderByDescending(p => p.CreatedAt).ToArray()
                : projects.OrderBy(p => p.CreatedAt).ToArray(),
            _ => projects
        };
    }

    private string GetSortIndicator(ProjectsSortColumn column)
    {
        if (sortColumn != column)
        {
            return string.Empty;
        }

        return sortDescending ? "" : "";
    }

    private async Task OnCustomerFilterChanged(ChangeEventArgs e)
    {
        filterCustomerId = e.Value?.ToString() ?? "";
        await LoadAsync();
    }

    private async Task OnStatusFilterChanged(ChangeEventArgs e)
    {
        filterStatus = e.Value?.ToString() ?? "";
        await LoadAsync();
    }

    private async Task CreateAsync()
    {
        // Ensure validation state is current
        if (createEditContext is not null && !createEditContext.Validate()) return;
        
        // Validate customer selection
        if (newProject!.CustomerId == 0)
        {
            ShowToast("Please select a customer", "danger");
            return;
        }

        var dto = new ProjectCreateDto(newProject!.Name, newProject.Description, newProject.CustomerId, newProject.CustomerOrderId, newProject.Status);
        var created = await ProjectsApi.CreateProjectAsync(dto);
        if (created is not null)
        {
            ShowToast("Project created successfully", "success");
            await LoadAsync();
            newProject = new();
            createEditContext = new EditContext(newProject);
            showCreateModal = false;
        }
    }

    private void StartEdit(ProjectDto p)
    {
        editModel = new EditModel 
        { 
            Id = p.Id, 
            Name = p.Name, 
            Description = p.Description,
            CustomerId = p.CustomerId,
            CustomerOrderId = p.CustomerOrderId,
            Status = p.Status
        };
        editEditContext = new EditContext(editModel);
        FilterOrdersForEdit();
        isEditing = true;
    }

    private async Task SaveEditAsync()
    {
        // Validate the form
        if (editEditContext != null && !editEditContext.Validate())
        {
            ShowToast("Please correct the validation errors", "danger");
            return;
        }
        
        // Validate customer selection
        if (editModel!.CustomerId == 0)
        {
            ShowToast("Please select a customer", "danger");
            return;
        }
        
        var dto = new ProjectCreateDto(editModel!.Name, editModel.Description, editModel.CustomerId, editModel.CustomerOrderId, editModel.Status);
        var ok = await ProjectsApi.UpdateProjectAsync(editModel!.Id, dto);
        if (ok)
        {
            ShowToast("Project updated successfully", "success");
            isEditing = false;
            await LoadAsync();
        }
        else
        {
            ShowToast("Failed to update project. Please try again.", "danger");
        }
    }

    private async Task DeleteProjectAsync(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this project?");
        if (!confirmed) return;
        
        var ok = await ProjectsApi.DeleteProjectAsync(id);
        if (ok)
        {
            ShowToast("Project deleted successfully", "success");
            await LoadAsync();
        }
        else
        {
            ShowToast("Failed to delete project", "danger");
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
        editModel = new();
    }

    private OrderWithCustomerDto? GetAssociatedOrder(int orderId)
    {
        if (allOrders == null || allOrders.Length == 0)
        {
            return null;
        }

        return allOrders.FirstOrDefault(o => o.Id == orderId);
    }

    private string GetStatusBadgeClass(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "active" => "bg-success",
            "expired" => "bg-danger",
            "pending" => "bg-warning text-dark",
            _ => "bg-secondary"
        };
    }
    
    private async Task ToggleProjectExpansionAsync(int projectId)
    {
        if (!expandedProjects.ContainsKey(projectId))
        {
            expandedProjects[projectId] = false;
        }
        
        expandedProjects[projectId] = !expandedProjects[projectId];
        
        if (expandedProjects[projectId] && !projectActivities.ContainsKey(projectId))
        {
            await LoadActivitiesAsync(projectId);
        }
        
        // Initialize default tab for project if not set
        if (!projectActiveTabs.ContainsKey(projectId))
        {
            projectActiveTabs[projectId] = "activities";
        }
    }
    
    private string GetProjectTab(int projectId)
    {
        return projectActiveTabs.ContainsKey(projectId) ? projectActiveTabs[projectId] : "activities";
    }
    
    private void SetProjectTab(int projectId, string tab)
    {
        projectActiveTabs[projectId] = tab;
    }
    
    private async Task SetProjectTabAsync(int projectId, string tab)
    {
        projectActiveTabs[projectId] = tab;
        
        // Load tasks if switching to Gantt tab and not loaded yet
        if (tab == "gantt" && !projectTasks.ContainsKey(projectId))
        {
            await LoadTasksAsync(projectId);
        }
    }
    
    private async Task LoadActivitiesAsync(int projectId)
    {
        try
        {
            loadingActivities[projectId] = true;
            var activities = await ProjectActivityApi.GetByProjectIdAsync(projectId);
            projectActivities[projectId] = activities?.OrderByDescending(a => a.ActivityDate).ToList();
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to load activities: {ex.Message}", "danger");
            projectActivities[projectId] = null;
        }
        finally
        {
            loadingActivities[projectId] = false;
        }
    }

    private async Task ShowProjectDetailsAsync(ProjectDto project)
    {
        selectedProjectDetails = project;
        showProjectDetailsModal = true;
        projectDetailsLoading = true;
        await EnsureProjectDetailsActivitiesAsync(project.Id);
        projectDetailsLoading = false;
    }

    private async Task EnsureProjectDetailsActivitiesAsync(int projectId)
    {
        if (!projectActivities.ContainsKey(projectId))
        {
            await LoadActivitiesAsync(projectId);
        }
        projectDetailsActivities = projectActivities.ContainsKey(projectId) ? projectActivities[projectId] : null;
    }

    private void HideProjectDetailsModal()
    {
        showProjectDetailsModal = false;
        selectedProjectDetails = null;
        projectDetailsActivities = null;
        projectDetailsLoading = false;
    }
    
    private void ShowToast(string message, string type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        
        // Auto-hide after 3 seconds
        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    private async Task ShowAddActivityFormAsync(int projectId)
    {
        if (currentEditingActivityId != null)
        {
            ShowToast("Please save or cancel the current edit first", "warning");
            return;
        }
        
        // Ensure model and context are initialized
        if (!newActivityModels.ContainsKey(projectId))
        {
            newActivityModels[projectId] = new NewActivityModel();
            activityCreateContexts[projectId] = new EditContext(newActivityModels[projectId]);
        }
        
        showAddActivity[projectId] = true;
        await InvokeAsync(StateHasChanged);
    }
    
    private void HideAddActivityForm(int projectId)
    {
        showAddActivity[projectId] = false;
        StateHasChanged();
    }
    
    private async Task CreateActivityAsync(int projectId)
    {
        if (!activityCreateContexts.ContainsKey(projectId))
        {
            ShowToast("Error: Activity form context not found", "danger");
            return;
        }
        
        if (!activityCreateContexts[projectId].Validate())
        {
            ShowToast("Please correct the validation errors", "danger");
            return;
        }
        
        try
        {
            var model = newActivityModels[projectId];
            var dto = new ProjectActivityCreateDto(
                projectId,
                model.ActivityDate,
                model.Summary,
                model.Description,
                model.NextAction,
                model.ActivityType,
                model.PerformedBy
            );
            
            // Try to call API and catch detailed errors
            try
            {
                var created = await ProjectActivityApi.CreateAsync(dto);
                if (created != null)
                {
                    ShowToast("Activity created successfully", "success");
                    showAddActivity[projectId] = false;
                    newActivityModels[projectId] = new NewActivityModel();
                    activityCreateContexts[projectId] = new EditContext(newActivityModels[projectId]);
                    await LoadActivitiesAsync(projectId);
                }
                else
                {
                    ShowToast("Failed to create activity: API returned null. Check if the backend service is running.", "danger");
                }
            }
            catch (HttpRequestException httpEx)
            {
                ShowToast($"Network error: {httpEx.Message}", "danger");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to create activity: {ex.Message}", "danger");
        }
    }
    
    private void StartEditActivity(int projectId, ProjectActivityDto activity)
    {
        if (currentEditingActivityId != null)
        {
            ShowToast("Please save or cancel the current edit first", "warning");
            return;
        }
        
        currentEditingProjectId = projectId;
        currentEditingActivityId = activity.Id;
        editActivityModel = new EditActivityModel
        {
            Id = activity.Id,
            ProjectId = activity.ProjectId,
            ActivityDate = activity.ActivityDate,
            Summary = activity.Summary,
            Description = activity.Description,
            NextAction = activity.NextAction,
            ActivityType = activity.ActivityType,
            PerformedBy = activity.PerformedBy
        };
    }
    
    private async Task SaveEditActivityAsync()
    {
        if (editActivityModel == null || currentEditingActivityId == null || currentEditingProjectId == null) return;
        
        try
        {
            var dto = new ProjectActivityDto(
                editActivityModel.Id,
                editActivityModel.ProjectId,
                editActivityModel.ActivityDate,
                editActivityModel.Summary,
                editActivityModel.Description,
                editActivityModel.NextAction,
                editActivityModel.ActivityType,
                editActivityModel.PerformedBy,
                null
            );
            
            var projectIdToRefresh = currentEditingProjectId.Value;
            var success = await ProjectActivityApi.UpdateAsync(currentEditingActivityId.Value, dto);
            if (success)
            {
                ShowToast("Activity updated successfully", "success");
                currentEditingProjectId = null;
                currentEditingActivityId = null;
                editActivityModel = null;
                await LoadActivitiesAsync(projectIdToRefresh);
            }
            else
            {
                ShowToast("Failed to update activity", "danger");
            }
        }
        catch (HttpRequestException httpEx)
        {
            ShowToast(httpEx.Message, "danger");
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to update activity: {ex.Message}", "danger");
        }
    }
    
    private async Task DeleteActivityAsync(int projectId, int activityId)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this activity?");
            if (!confirmed) return;
            
            var success = await ProjectActivityApi.DeleteAsync(activityId);
            if (success)
            {
                ShowToast("Activity deleted successfully", "success");
                await LoadActivitiesAsync(projectId);
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to delete activity: {ex.Message}", "danger");
        }
    }
    
    private void CancelEditActivity()
    {
        currentEditingProjectId = null;
        currentEditingActivityId = null;
        editActivityModel = null;
    }
    
    // Task management methods
    private async Task LoadTasksAsync(int projectId)
    {
        try
        {
            loadingTasks[projectId] = true;
            var tasks = await ProjectTaskApi.GetTasksByProjectIdAsync(projectId);
            projectTasks[projectId] = tasks?.OrderBy(t => t.DisplayOrder).ThenBy(t => t.StartAtUtc).ToList();
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to load tasks: {ex.Message}", "danger");
            projectTasks[projectId] = null;
        }
        finally
        {
            loadingTasks[projectId] = false;
        }
    }
    
    private void ShowAddTaskForm(int projectId)
    {
        newTaskModel = new NewTaskModel { StartDate = DateTime.Now, EndDate = DateTime.Now.AddDays(1) };
        showAddTask[projectId] = true;
    }
    
    private void HideAddTaskForm(int projectId)
    {
        showAddTask[projectId] = false;
        newTaskModel = new();
    }
    
    private async Task CreateTaskAsync(int projectId)
    {
        try
        {
            var dto = new CreateProjectTaskDto(
                newTaskModel.Title,
                newTaskModel.Description,
                newTaskModel.StartDate.ToUniversalTime(),
                newTaskModel.EndDate.ToUniversalTime(),
                newTaskModel.Status,
                0
            );
            
            var created = await ProjectTaskApi.CreateTaskAsync(projectId, dto);
            if (created != null)
            {
                ShowToast("Task created successfully", "success");
                showAddTask[projectId] = false;
                newTaskModel = new();
                await LoadTasksAsync(projectId);
            }
            else
            {
                ShowToast("Failed to create task", "danger");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to create task: {ex.Message}", "danger");
        }
    }
    
    private void StartEditTask(int projectId, ProjectTaskDto task)
    {
        currentEditingProjectId = projectId;
        currentEditingTaskId = task.Id;
        editTaskModel = new EditTaskModel
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            StartDate = task.StartAtUtc.ToLocalTime(),
            EndDate = task.EndAtUtc.ToLocalTime(),
            Status = task.Status,
            DisplayOrder = task.DisplayOrder
        };
    }
    
    private async Task SaveEditTaskAsync()
    {
        if (editTaskModel == null || currentEditingTaskId == null || currentEditingProjectId == null) return;
        
        try
        {
            var dto = new UpdateProjectTaskDto(
                editTaskModel.Title,
                editTaskModel.Description,
                editTaskModel.StartDate.ToUniversalTime(),
                editTaskModel.EndDate.ToUniversalTime(),
                editTaskModel.Status,
                editTaskModel.DisplayOrder
            );
            
            var projectIdToRefresh = currentEditingProjectId.Value;
            var success = await ProjectTaskApi.UpdateTaskAsync(currentEditingTaskId.Value, dto);
            if (success)
            {
                ShowToast("Task updated successfully", "success");
                currentEditingProjectId = null;
                currentEditingTaskId = null;
                editTaskModel = null;
                await LoadTasksAsync(projectIdToRefresh);
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to update task: {ex.Message}", "danger");
        }
    }
    
    private async Task DeleteTaskAsync(int projectId, int taskId)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this task?");
            if (!confirmed) return;
            
            var success = await ProjectTaskApi.DeleteTaskAsync(taskId);
            if (success)
            {
                ShowToast("Task deleted successfully", "success");
                await LoadTasksAsync(projectId);
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to delete task: {ex.Message}", "danger");
        }
    }
    
    private void CancelEditTask()
    {
        currentEditingProjectId = null;
        currentEditingTaskId = null;
        editTaskModel = null;
    }

    private string GetProjectCalendarLink(ProjectDto project)
    {
        var parameters = new Dictionary<string, object?>
        {
            ["projectId"] = project.Id,
            ["projectName"] = project.Name,
            ["view"] = "tasks",
            ["scheduleType"] = "project"
        };

        return Navigation.GetUriWithQueryParameters("/", parameters);
    }

    private void ParseProjectQueryParameters()
    {
        var uri = new Uri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("projectId", out var projectIdValue) && int.TryParse(projectIdValue, out var parsedId) && parsedId > 0)
        {
            highlightProjectIdFromQuery = parsedId;
        }

        if (query.TryGetValue("tab", out var tabValues))
        {
            var tabText = tabValues.ToString();
            if (!string.IsNullOrWhiteSpace(tabText))
            {
                highlightProjectTabFromQuery = NormalizeProjectTab(tabText);
            }
        }
        else if (query.TryGetValue("view", out var viewValues))
        {
            var viewText = viewValues.ToString();
            if (string.Equals(viewText, "tasks", StringComparison.OrdinalIgnoreCase))
            {
                highlightProjectTabFromQuery = "gantt";
            }
            else if (string.Equals(viewText, "issue", StringComparison.OrdinalIgnoreCase))
            {
                highlightProjectTabFromQuery = "activities";
            }
        }
    }

    private async Task ApplyHighlightedProjectAsync()
    {
        if (!highlightProjectIdFromQuery.HasValue || highlightProjectApplied)
        {
            return;
        }

        var projectId = highlightProjectIdFromQuery.Value;
        expandedProjects[projectId] = true;
        var tab = NormalizeProjectTab(highlightProjectTabFromQuery);
        projectActiveTabs[projectId] = tab;

        if (tab == "activities")
        {
            await LoadActivitiesAsync(projectId);
        }
        else if (tab == "gantt")
        {
            await LoadTasksAsync(projectId);
        }

        highlightProjectApplied = true;
    }

    private string NormalizeProjectTab(string? tab)
    {
        if (string.IsNullOrWhiteSpace(tab))
        {
            return "activities";
        }

        return tab.ToLowerInvariant() switch
        {
            "activity" => "activities",
            "activities" => "activities",
            "issue" => "activities",
            "gantt" => "gantt",
            "tasks" => "gantt",
            "files" => "files",
            _ => "activities"
        };
    }

    class NewModel 
    { 
        [Required] public string Name { get; set; } = string.Empty; 
        public string? Description { get; set; }
        [Required] public int CustomerId { get; set; }
        public int? CustomerOrderId { get; set; }
        public ProjectStatus Status { get; set; } = ProjectStatus.Wip;
    }
    
    class EditModel 
    { 
        public int Id { get; set; } 
        [Required] public string Name { get; set; } = string.Empty; 
        public string? Description { get; set; }
        [Required] public int CustomerId { get; set; }
        public int? CustomerOrderId { get; set; }
        public ProjectStatus Status { get; set; } = ProjectStatus.Wip;
    }
    
    class NewActivityModel
    {
        [Required] public DateTime ActivityDate { get; set; } = DateTime.UtcNow;
        [Required, MaxLength(500)] public string Summary { get; set; } = string.Empty;
        [MaxLength(5000)] public string? Description { get; set; }
        [MaxLength(1000)] public string? NextAction { get; set; }
        [MaxLength(100)] public string? ActivityType { get; set; }
        [MaxLength(200)] public string? PerformedBy { get; set; }
    }
    
    class EditActivityModel
    {
        public int Id { get; set; }
        public int ProjectId { get; set; }
        [Required] public DateTime ActivityDate { get; set; } = DateTime.UtcNow;
        [Required, MaxLength(500)] public string Summary { get; set; } = string.Empty;
        [MaxLength(5000)] public string? Description { get; set; }
        [MaxLength(1000)] public string? NextAction { get; set; }
        [MaxLength(100)] public string? ActivityType { get; set; }
        [MaxLength(200)] public string? PerformedBy { get; set; }
    }
    
    class NewTaskModel
    {
        [Required, MaxLength(500)] public string Title { get; set; } = string.Empty;
        [MaxLength(5000)] public string? Description { get; set; }
        [Required] public DateTime StartDate { get; set; } = DateTime.Now;
        [Required] public DateTime EndDate { get; set; } = DateTime.Now.AddDays(1);
        public ProjectTaskStatus Status { get; set; } = ProjectTaskStatus.NotStarted;
    }
    
    class EditTaskModel
    {
        public int Id { get; set; }
        [Required, MaxLength(500)] public string Title { get; set; } = string.Empty;
        [MaxLength(5000)] public string? Description { get; set; }
        [Required] public DateTime StartDate { get; set; } = DateTime.Now;
        [Required] public DateTime EndDate { get; set; } = DateTime.Now.AddDays(1);
        public ProjectTaskStatus Status { get; set; } = ProjectTaskStatus.NotStarted;
        public int DisplayOrder { get; set; }
    }

    public void Dispose()
    {
        Localizer.OnLanguageChanged -= OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void ShowCreateModal()
    {
        filteredOrders = null;
        showCreateModal = true;
    }
    
    private void HideCreateModal()
    {
        showCreateModal = false;
        filteredOrders = null;
        newProject = new();
        createEditContext = new EditContext(newProject);
    }

    private void OnNewProjectCustomerChanged()
    {
        // Clear order when customer changes (lifecycle hook)
        newProject!.CustomerOrderId = null;
        FilterOrders(newProject.CustomerId);
    }

    private void OnEditProjectCustomerChanged()
    {
        // Clear order when customer changes (lifecycle hook)
        editModel!.CustomerOrderId = null;
        FilterOrders(editModel.CustomerId);
    }

    private void FilterOrders(int customerId)
    {
        if (customerId > 0 && allOrders != null)
        {
            filteredOrders = allOrders.Where(o => o.CustomerId == customerId).ToArray();
        }
        else
        {
            filteredOrders = null;
        }
    }

    private void FilterOrdersForNew()
    {
        FilterOrders(newProject!.CustomerId);
    }

    private void FilterOrdersForEdit()
    {
        FilterOrders(editModel!.CustomerId);
    }

    private enum ProjectsSortColumn
    {
        Name,
        Customer,
        Status,
        Created
    }
}

