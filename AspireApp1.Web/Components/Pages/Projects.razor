@page "/projects"
@rendermode InteractiveServer
@inject ProjectsApiClient ProjectsApi
@inject CustomerApiClient CustomersApi
@inject ProjectActivityApiClient ProjectActivityApi
@inject EntityFilesApiClient EntityFilesApi
@inject IJSRuntime JSRuntime
@inject LocalizationService Localizer
@using System.ComponentModel.DataAnnotations
@using AspireApp1.Web
@using Microsoft.AspNetCore.Components.Forms
@implements IDisposable

<PageTitle>@Localizer.GetString("Projects")</PageTitle>

<h1>@Localizer.GetString("Projects")</h1>

@if (showToast && !string.IsNullOrEmpty(toastMessage))
{
    <div class="alert @(toastType == "success" ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @toastMessage
        <button type="button" class="btn-close" @onclick="() => showToast = false"></button>
    </div>
}

<div class="row mb-3">
    <div class="col-md-12">
        <h5>@Localizer.GetString("Filters")</h5>
        <div class="row g-2">
            <div class="col-md-4">
                <label class="form-label">@Localizer.GetString("Customer")</label>
                <select class="form-select" value="@filterCustomerId" @onchange="OnCustomerFilterChanged">
                    <option value="">@Localizer.GetString("All Customers")</option>
                    @if (customers != null)
                    {
                        @foreach (var c in customers)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">@Localizer.GetString("Status")</label>
                <select class="form-select" value="@filterStatus" @onchange="OnStatusFilterChanged">
                    <option value="">@Localizer.GetString("All Statuses")</option>
                    <option value="Wip">WIP</option>
                    <option value="Pending">Pending</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <h4>@Localizer.GetString("Existing Projects")</h4>
        @if (!string.IsNullOrEmpty(loadError))
        {
            <div class="alert alert-warning">Unable to load projects: @loadError</div>
        }
        else if (projects is null)
        {
            <p><em>@Localizer.GetString("Loading...")</em></p>
        }
        else if (projects.Length == 0)
        {
            <p class="text-muted">@Localizer.GetString("No projects.")</p>
        }
        else
        {
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;"></th>
                        <th>@Localizer.GetString("Name")</th>
                        <th>@Localizer.GetString("Customer")</th>
                        <th>@Localizer.GetString("Status")</th>
                        <th>@Localizer.GetString("Created")</th>
                        <th>@Localizer.GetString("Actions")</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in projects)
                    {
                        <tr>
                            <td style="vertical-align: middle;">
                                <button class="btn btn-link p-1" style="font-size: 1.5rem; line-height: 1; color: var(--bs-primary);" @onclick="() => ToggleProjectExpansionAsync(p.Id)">
                                    <i class="bi @(expandedProjects.ContainsKey(p.Id) && expandedProjects[p.Id] ? "bi-chevron-down" : "bi-chevron-right")" style="font-weight: bold;"></i>
                                </button>
                            </td>
                            <td>
                                <strong>@p.Name</strong>
                                @if (!string.IsNullOrWhiteSpace(p.Description))
                                {
                                    <div class="small text-muted">@p.Description</div>
                                }
                            </td>
                            <td>@p.CustomerName</td>
                            <td>
                                @if (p.Status == ProjectStatus.Wip)
                                {
                                    <span class="badge bg-primary">WIP</span>
                                }
                                else if (p.Status == ProjectStatus.Pending)
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                                else if (p.Status == ProjectStatus.Closed)
                                {
                                    <span class="badge bg-secondary">Closed</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@p.Status</span>
                                }
                            </td>
                            <td class="small">@p.CreatedAt.ToLocalTime().ToString("g")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEdit(p)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProjectAsync(p.Id)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        
                        @* Nested activities section *@
                        @if (expandedProjects.ContainsKey(p.Id) && expandedProjects[p.Id])
                        {
                            <tr>
                                <td colspan="6" class="ps-5" style="background-color: var(--bg-secondary);">
                                    @* Project detail tabs *@
                                    <div class="py-3">
                                        <ul class="nav nav-tabs mb-3" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(GetProjectTab(p.Id) == "activities" ? "active" : "")" 
                                                        type="button"
                                                        @onclick="@(() => SetProjectTab(p.Id, "activities"))"
                                                        role="tab">
                                                    <span class="bi bi-calendar-event"></span> Activities
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link @(GetProjectTab(p.Id) == "files" ? "active" : "")" 
                                                        type="button"
                                                        @onclick="@(() => SetProjectTab(p.Id, "files"))"
                                                        role="tab">
                                                    <span class="bi bi-file-earmark-arrow-up"></span> Files
                                                </button>
                                            </li>
                                        </ul>

                                        @if (GetProjectTab(p.Id) == "activities")
                                        {
                                            @if (loadingActivities.ContainsKey(p.Id) && loadingActivities[p.Id])
                                            {
                                                <div class="text-center py-3">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <span class="ms-2">Loading activities...</span>
                                                </div>
                                            }
                                            else if (!projectActivities.ContainsKey(p.Id) || projectActivities[p.Id] == null || !projectActivities[p.Id]!.Any())
                                            {
                                                <div class="py-3">
                                                    <p class="text-muted mb-2">No activities yet.</p>
                                            
                                            @if (!showAddActivity.ContainsKey(p.Id) || !showAddActivity[p.Id])
                                            {
                                                <button class="btn btn-sm btn-primary" @onclick="async () => await ShowAddActivityFormAsync(p.Id)" disabled="@(currentEditingActivityId != null)">
                                                    <i class="bi bi-plus-circle me-1"></i> Add New Activity
                                                </button>
                                            }
                                            else if (newActivityModels.ContainsKey(p.Id) && activityCreateContexts.ContainsKey(p.Id))
                                            {
                                                var model = newActivityModels[p.Id];
                                                var context = activityCreateContexts[p.Id];
                                                <div class="card mt-2">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">New Activity</h6>
                                                        <button class="btn btn-sm btn-secondary" @onclick="() => HideAddActivityForm(p.Id)">Cancel</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <EditForm EditContext="@context" OnValidSubmit="() => CreateActivityAsync(p.Id)">
                                                            <DataAnnotationsValidator />
                                                            <ValidationSummary />
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Activity Date *</label>
                                                                    <InputDate @bind-Value="model.ActivityDate" class="form-control" />
                                                                    <ValidationMessage For="() => model.ActivityDate" />
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Summary *</label>
                                                                    <InputText @bind-Value="model.Summary" class="form-control" />
                                                                    <ValidationMessage For="() => model.Summary" />
                                                                </div>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Description</label>
                                                                <InputTextArea @bind-Value="model.Description" class="form-control" rows="3" />
                                                                <ValidationMessage For="() => model.Description" />
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Next Action</label>
                                                                <InputTextArea @bind-Value="model.NextAction" class="form-control" rows="2" />
                                                                <ValidationMessage For="() => model.NextAction" />
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Activity Type</label>
                                                                    <InputText @bind-Value="model.ActivityType" class="form-control" />
                                                                    <ValidationMessage For="() => model.ActivityType" />
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Performed By</label>
                                                                    <InputText @bind-Value="model.PerformedBy" class="form-control" />
                                                                    <ValidationMessage For="() => model.PerformedBy" />
                                                                </div>
                                                            </div>
                                                            <button class="btn btn-primary w-100" type="submit">Create Activity</button>
                                                        </EditForm>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="py-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h6 class="mb-0">Activities</h6>
                                                @if (!showAddActivity.ContainsKey(p.Id) || !showAddActivity[p.Id])
                                                {
                                                    <button class="btn btn-sm btn-primary" @onclick="async () => await ShowAddActivityFormAsync(p.Id)" disabled="@(currentEditingActivityId != null)">
                                                        <i class="bi bi-plus-circle me-1"></i> Add New Activity
                                                    </button>
                                                }
                                            </div>
                                            
                                            @if (showAddActivity.ContainsKey(p.Id) && showAddActivity[p.Id] && newActivityModels.ContainsKey(p.Id) && activityCreateContexts.ContainsKey(p.Id))
                                            {
                                                var model = newActivityModels[p.Id];
                                                var context = activityCreateContexts[p.Id];
                                                <div class="card mb-3">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">New Activity</h6>
                                                        <button class="btn btn-sm btn-secondary" @onclick="() => HideAddActivityForm(p.Id)">Cancel</button>
                                                    </div>
                                                    <div class="card-body">
                                                        <EditForm EditContext="@context" OnValidSubmit="() => CreateActivityAsync(p.Id)">
                                                            <DataAnnotationsValidator />
                                                            <ValidationSummary />
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Activity Date *</label>
                                                                    <InputDate @bind-Value="model.ActivityDate" class="form-control" />
                                                                    <ValidationMessage For="() => model.ActivityDate" />
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Summary *</label>
                                                                    <InputText @bind-Value="model.Summary" class="form-control" />
                                                                    <ValidationMessage For="() => model.Summary" />
                                                                </div>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Description</label>
                                                                <InputTextArea @bind-Value="model.Description" class="form-control" rows="3" />
                                                                <ValidationMessage For="() => model.Description" />
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Next Action</label>
                                                                <InputTextArea @bind-Value="model.NextAction" class="form-control" rows="2" />
                                                                <ValidationMessage For="() => model.NextAction" />
                                                            </div>
                                                            <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Activity Type</label>
                                                                    <InputText @bind-Value="model.ActivityType" class="form-control" />
                                                                    <ValidationMessage For="() => model.ActivityType" />
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                    <label class="form-label">Performed By</label>
                                                                    <InputText @bind-Value="model.PerformedBy" class="form-control" />
                                                                    <ValidationMessage For="() => model.PerformedBy" />
                                                                </div>
                                                            </div>
                                                            <button class="btn btn-primary w-100" type="submit">Create Activity</button>
                                                        </EditForm>
                                                    </div>
                                                </div>
                                            }
                                            
                                            <table class="table table-sm table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Summary</th>
                                                        <th>Description</th>
                                                        <th>Next Action</th>
                                                        <th>Type</th>
                                                        <th>Performed By</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var activity in projectActivities[p.Id]!)
                                                    {
                                                        <tr>
                                                            <td class="small">@activity.ActivityDate.ToLocalTime().ToString("g")</td>
                                                            <td>@activity.Summary</td>
                                                            <td class="small">@activity.Description</td>
                                                            <td class="small">@activity.NextAction</td>
                                                            <td class="small">@activity.ActivityType</td>
                                                            <td class="small">@activity.PerformedBy</td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => StartEditActivity(p.Id, activity)">
                                                                    <i class="bi bi-pencil"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteActivityAsync(p.Id, activity.Id)">
                                                                    <i class="bi bi-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        
                                                        @* Inline edit form for activity *@
                                                        @if (currentEditingActivityId == activity.Id && currentEditingProjectId == p.Id && editActivityModel != null)
                                                        {
                                                            <tr>
                                                                <td colspan="7" class="border-top-0">
                                                                    <div class="card mt-2 mb-3">
                                                                        <div class="card-header d-flex justify-content-between align-items-center">
                                                                            <h6 class="mb-0">Edit Activity</h6>
                                                                            <button class="btn btn-sm btn-secondary" @onclick="CancelEditActivity">Cancel</button>
                                                                        </div>
                                                                        <div class="card-body">
                                                                            <EditForm Model="editActivityModel" OnValidSubmit="SaveEditActivityAsync">
                                                                                <DataAnnotationsValidator />
                                                                                <ValidationSummary />
                                                                                <div class="row">
                                                                                    <div class="col-md-6 mb-3">
                                                                                        <label class="form-label">Activity Date *</label>
                                                                                        <InputDate @bind-Value="editActivityModel.ActivityDate" class="form-control" />
                                                                                        <ValidationMessage For="() => editActivityModel.ActivityDate" />
                                                                                    </div>
                                                                                    <div class="col-md-6 mb-3">
                                                                                        <label class="form-label">Summary *</label>
                                                                                        <InputText @bind-Value="editActivityModel.Summary" class="form-control" />
                                                                                        <ValidationMessage For="() => editActivityModel.Summary" />
                                                                                    </div>
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label">Description</label>
                                                                                    <InputTextArea @bind-Value="editActivityModel.Description" class="form-control" rows="3" />
                                                                                    <ValidationMessage For="() => editActivityModel.Description" />
                                                                                </div>
                                                                                <div class="mb-3">
                                                                                    <label class="form-label">Next Action</label>
                                                                                    <InputTextArea @bind-Value="editActivityModel.NextAction" class="form-control" rows="2" />
                                                                                    <ValidationMessage For="() => editActivityModel.NextAction" />
                                                                                </div>
                                                                                <div class="row">
                                                                                    <div class="col-md-6 mb-3">
                                                                                        <label class="form-label">Activity Type</label>
                                                                                        <InputText @bind-Value="editActivityModel.ActivityType" class="form-control" />
                                                                                        <ValidationMessage For="() => editActivityModel.ActivityType" />
                                                                                    </div>
                                                                                    <div class="col-md-6 mb-3">
                                                                                        <label class="form-label">Performed By</label>
                                                                                        <InputText @bind-Value="editActivityModel.PerformedBy" class="form-control" />
                                                                                        <ValidationMessage For="() => editActivityModel.PerformedBy" />
                                                                                    </div>
                                                                                </div>
                                                                                <div class="d-flex gap-2">
                                                                                    <button class="btn btn-primary" type="submit">Save Changes</button>
                                                                                    <button class="btn btn-secondary" type="button" @onclick="CancelEditActivity">Cancel</button>
                                                                                </div>
                                                                            </EditForm>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                            }
                                        }
                                        else if (GetProjectTab(p.Id) == "files")
                                        {
                                            <FileManager EntityType="Project" EntityId="p.Id" />
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        }
    </div>
</div>

<div class="row mt-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">@Localizer.GetString("Create Project")</h5>
                <button class="btn btn-sm btn-outline-primary" @onclick="() => showCreateForm = !showCreateForm">
                    <i class="bi @(showCreateForm ? "bi-chevron-up" : "bi-chevron-down")"></i>
                </button>
            </div>
            @if (showCreateForm)
            {
                <div class="card-body">
                <EditForm EditContext="createEditContext" OnValidSubmit="CreateAsync" FormName="createForm">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name *</label>
                            <InputText @bind-Value="newProject!.Name" class="form-control" placeholder="Project Name" />
                            <ValidationMessage For="() => newProject!.Name" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Customer *</label>
                            <InputSelect @bind-Value="newProject.CustomerId" class="form-select">
                                <option value="">-- Select Customer --</option>
                                @if (customers != null)
                                {
                                    @foreach (var c in customers)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="() => newProject!.CustomerId" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Status</label>
                            <InputSelect @bind-Value="newProject.Status" class="form-select">
                                <option value="@ProjectStatus.Wip">WIP</option>
                                <option value="@ProjectStatus.Pending">Pending</option>
                                <option value="@ProjectStatus.Closed">Closed</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <InputTextArea @bind-Value="newProject.Description" class="form-control" placeholder="Description" rows="4" />
                    </div>
                    <button class="btn btn-primary" type="submit">@Localizer.GetString("Create Project")</button>
                </EditForm>
                </div>
            }
        </div>
    </div>
</div>

@if (isEditing)
{
    <div class="row mt-4">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Edit Project</h5>
                    <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Cancel</button>
                </div>
                <div class="card-body">
                    <EditForm EditContext="editEditContext" OnValidSubmit="SaveEditAsync" FormName="editForm">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <input type="hidden" @bind="editModel!.Id" />
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <InputText @bind-Value="editModel!.Name" class="form-control" />
                            <ValidationMessage For="() => editModel!.Name" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <InputTextArea @bind-Value="editModel!.Description" class="form-control" rows="3" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Customer *</label>
                            <InputSelect @bind-Value="editModel.CustomerId" class="form-select">
                                <option value="">-- Select Customer --</option>
                                @if (customers != null)
                                {
                                    @foreach (var c in customers)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                            </InputSelect>
                            <ValidationMessage For="() => editModel!.CustomerId" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <InputSelect @bind-Value="editModel.Status" class="form-select">
                                <option value="@ProjectStatus.Wip">WIP</option>
                                <option value="@ProjectStatus.Pending">Pending</option>
                                <option value="@ProjectStatus.Closed">Closed</option>
                            </InputSelect>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" type="submit">Save Changes</button>
                            <button class="btn btn-secondary" type="button" @onclick="CancelEdit">Cancel</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private Web.ProjectDto[]? projects;
    private Web.CustomerDto[]? customers;
    private string? loadError;
    private string filterCustomerId = "";
    private string filterStatus = "";
    
    [SupplyParameterFromForm]
    private NewModel? newProject { get; set; }
    
    [SupplyParameterFromForm]
    private EditModel? editModel { get; set; }
    
    private bool isEditing;
    private EditContext? createEditContext;
    private EditContext? editEditContext;
    
    // Activity state management
    private Dictionary<int, bool> expandedProjects = new();
    private Dictionary<int, List<ProjectActivityDto>?> projectActivities = new();
    private Dictionary<int, bool> loadingActivities = new();
    private Dictionary<int, bool> showAddActivity = new();
    private Dictionary<int, string> projectActiveTabs = new();  // Track active tab per project
    
    // Single edit tracking
    private int? currentEditingProjectId;
    private int? currentEditingActivityId;
    private EditActivityModel? editActivityModel;
    
    // Activity form models
    private Dictionary<int, NewActivityModel> newActivityModels = new();
    private Dictionary<int, EditContext> activityCreateContexts = new();
    
    // Toast state
    private string? toastMessage;
    private string? toastType;
    private bool showToast;
    
    // Create form visibility
    private bool showCreateForm = false;

    protected override async Task OnInitializedAsync()
    {
        Localizer.OnLanguageChanged += OnLanguageChanged;
        newProject ??= new();
        editModel ??= new();
        createEditContext = new EditContext(newProject);
        editEditContext = new EditContext(editModel);
        await LoadCustomersAsync();
        await LoadAsync();
    }

    private async Task LoadCustomersAsync()
    {
        try
        {
            customers = await CustomersApi.GetCustomersAsync();
        }
        catch
        {
            customers = Array.Empty<CustomerDto>();
        }
    }

    private async Task LoadAsync()
    {
        try
        {
            int? customerId = string.IsNullOrEmpty(filterCustomerId) ? null : int.Parse(filterCustomerId);
            ProjectStatus? status = string.IsNullOrEmpty(filterStatus) ? null : Enum.Parse<ProjectStatus>(filterStatus);
            projects = await ProjectsApi.GetProjectsAsync(customerId, status);
            loadError = null;
        }
        catch (Exception ex)
        {
            projects = Array.Empty<ProjectDto>();
            loadError = ex.Message;
        }
    }

    private async Task ApplyFiltersAsync()
    {
        await LoadAsync();
    }

    private async Task OnCustomerFilterChanged(ChangeEventArgs e)
    {
        filterCustomerId = e.Value?.ToString() ?? "";
        await LoadAsync();
    }

    private async Task OnStatusFilterChanged(ChangeEventArgs e)
    {
        filterStatus = e.Value?.ToString() ?? "";
        await LoadAsync();
    }

    private async Task CreateAsync()
    {
        // Ensure validation state is current
        if (createEditContext is not null && !createEditContext.Validate()) return;

        var dto = new ProjectCreateDto(newProject!.Name, newProject.Description, newProject.CustomerId, newProject.Status);
        var created = await ProjectsApi.CreateProjectAsync(dto);
        if (created is not null)
        {
            ShowToast("Project created successfully", "success");
            await LoadAsync();
            newProject = new();
            createEditContext = new EditContext(newProject);
            showCreateForm = false;
        }
    }

    private void StartEdit(ProjectDto p)
    {
        editModel = new EditModel 
        { 
            Id = p.Id, 
            Name = p.Name, 
            Description = p.Description,
            CustomerId = p.CustomerId,
            Status = p.Status
        };
        editEditContext = new EditContext(editModel);
        isEditing = true;
    }

    private async Task SaveEditAsync()
    {
        var dto = new ProjectCreateDto(editModel!.Name, editModel.Description, editModel.CustomerId, editModel.Status);
        var ok = await ProjectsApi.UpdateProjectAsync(editModel!.Id, dto);
        if (ok)
        {
            isEditing = false;
            await LoadAsync();
        }
    }

    private async Task DeleteProjectAsync(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this project?");
        if (!confirmed) return;
        
        var ok = await ProjectsApi.DeleteProjectAsync(id);
        if (ok)
        {
            ShowToast("Project deleted successfully", "success");
            await LoadAsync();
        }
        else
        {
            ShowToast("Failed to delete project", "danger");
        }
    }

    private void CancelEdit()
    {
        isEditing = false;
        editModel = new();
    }
    
    private async Task ToggleProjectExpansionAsync(int projectId)
    {
        if (!expandedProjects.ContainsKey(projectId))
        {
            expandedProjects[projectId] = false;
        }
        
        expandedProjects[projectId] = !expandedProjects[projectId];
        
        if (expandedProjects[projectId] && !projectActivities.ContainsKey(projectId))
        {
            await LoadActivitiesAsync(projectId);
        }
        
        // Initialize default tab for project if not set
        if (!projectActiveTabs.ContainsKey(projectId))
        {
            projectActiveTabs[projectId] = "activities";
        }
    }
    
    private string GetProjectTab(int projectId)
    {
        return projectActiveTabs.ContainsKey(projectId) ? projectActiveTabs[projectId] : "activities";
    }
    
    private void SetProjectTab(int projectId, string tab)
    {
        projectActiveTabs[projectId] = tab;
    }
    
    private async Task LoadActivitiesAsync(int projectId)
    {
        try
        {
            loadingActivities[projectId] = true;
            var activities = await ProjectActivityApi.GetByProjectIdAsync(projectId);
            projectActivities[projectId] = activities?.OrderByDescending(a => a.ActivityDate).ToList();
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to load activities: {ex.Message}", "danger");
            projectActivities[projectId] = null;
        }
        finally
        {
            loadingActivities[projectId] = false;
        }
    }
    
    private void ShowToast(string message, string type)
    {
        toastMessage = message;
        toastType = type;
        showToast = true;
        
        // Auto-hide after 3 seconds
        Task.Delay(3000).ContinueWith(_ =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
        });
    }
    
    private async Task ShowAddActivityFormAsync(int projectId)
    {
        if (currentEditingActivityId != null)
        {
            ShowToast("Please save or cancel the current edit first", "warning");
            return;
        }
        
        // Ensure model and context are initialized
        if (!newActivityModels.ContainsKey(projectId))
        {
            newActivityModels[projectId] = new NewActivityModel();
            activityCreateContexts[projectId] = new EditContext(newActivityModels[projectId]);
        }
        
        showAddActivity[projectId] = true;
        await InvokeAsync(StateHasChanged);
    }
    
    private void HideAddActivityForm(int projectId)
    {
        showAddActivity[projectId] = false;
        StateHasChanged();
    }
    
    private async Task CreateActivityAsync(int projectId)
    {
        if (!activityCreateContexts.ContainsKey(projectId))
        {
            ShowToast("Error: Activity form context not found", "danger");
            return;
        }
        
        if (!activityCreateContexts[projectId].Validate())
        {
            ShowToast("Please correct the validation errors", "danger");
            return;
        }
        
        try
        {
            var model = newActivityModels[projectId];
            var dto = new ProjectActivityCreateDto(
                projectId,
                model.ActivityDate,
                model.Summary,
                model.Description,
                model.NextAction,
                model.ActivityType,
                model.PerformedBy
            );
            
            // Try to call API and catch detailed errors
            try
            {
                var created = await ProjectActivityApi.CreateAsync(dto);
                if (created != null)
                {
                    ShowToast("Activity created successfully", "success");
                    showAddActivity[projectId] = false;
                    newActivityModels[projectId] = new NewActivityModel();
                    activityCreateContexts[projectId] = new EditContext(newActivityModels[projectId]);
                    await LoadActivitiesAsync(projectId);
                }
                else
                {
                    ShowToast("Failed to create activity: API returned null. Check if the backend service is running.", "danger");
                }
            }
            catch (HttpRequestException httpEx)
            {
                ShowToast($"Network error: {httpEx.Message}", "danger");
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to create activity: {ex.Message}", "danger");
        }
    }
    
    private void StartEditActivity(int projectId, ProjectActivityDto activity)
    {
        if (currentEditingActivityId != null)
        {
            ShowToast("Please save or cancel the current edit first", "warning");
            return;
        }
        
        currentEditingProjectId = projectId;
        currentEditingActivityId = activity.Id;
        editActivityModel = new EditActivityModel
        {
            Id = activity.Id,
            ProjectId = activity.ProjectId,
            ActivityDate = activity.ActivityDate,
            Summary = activity.Summary,
            Description = activity.Description,
            NextAction = activity.NextAction,
            ActivityType = activity.ActivityType,
            PerformedBy = activity.PerformedBy
        };
    }
    
    private async Task SaveEditActivityAsync()
    {
        if (editActivityModel == null || currentEditingActivityId == null || currentEditingProjectId == null) return;
        
        try
        {
            var dto = new ProjectActivityDto(
                editActivityModel.Id,
                editActivityModel.ProjectId,
                editActivityModel.ActivityDate,
                editActivityModel.Summary,
                editActivityModel.Description,
                editActivityModel.NextAction,
                editActivityModel.ActivityType,
                editActivityModel.PerformedBy,
                null
            );
            
            var projectIdToRefresh = currentEditingProjectId.Value;
            var success = await ProjectActivityApi.UpdateAsync(currentEditingActivityId.Value, dto);
            if (success)
            {
                ShowToast("Activity updated successfully", "success");
                currentEditingProjectId = null;
                currentEditingActivityId = null;
                editActivityModel = null;
                await LoadActivitiesAsync(projectIdToRefresh);
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to update activity: {ex.Message}", "danger");
        }
    }
    
    private async Task DeleteActivityAsync(int projectId, int activityId)
    {
        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this activity?");
            if (!confirmed) return;
            
            var success = await ProjectActivityApi.DeleteAsync(activityId);
            if (success)
            {
                ShowToast("Activity deleted successfully", "success");
                await LoadActivitiesAsync(projectId);
            }
        }
        catch (Exception ex)
        {
            ShowToast($"Failed to delete activity: {ex.Message}", "danger");
        }
    }
    
    private void CancelEditActivity()
    {
        currentEditingProjectId = null;
        currentEditingActivityId = null;
        editActivityModel = null;
    }

    class NewModel 
    { 
        [Required] public string Name { get; set; } = string.Empty; 
        public string? Description { get; set; }
        [Required] public int CustomerId { get; set; }
        public ProjectStatus Status { get; set; } = ProjectStatus.Wip;
    }
    
    class EditModel 
    { 
        public int Id { get; set; } 
        [Required] public string Name { get; set; } = string.Empty; 
        public string? Description { get; set; }
        [Required] public int CustomerId { get; set; }
        public ProjectStatus Status { get; set; } = ProjectStatus.Wip;
    }
    
    class NewActivityModel
    {
        [Required] public DateTime ActivityDate { get; set; } = DateTime.UtcNow;
        [Required, MaxLength(500)] public string Summary { get; set; } = string.Empty;
        [MaxLength(5000)] public string? Description { get; set; }
        [MaxLength(1000)] public string? NextAction { get; set; }
        [MaxLength(100)] public string? ActivityType { get; set; }
        [MaxLength(200)] public string? PerformedBy { get; set; }
    }
    
    class EditActivityModel
    {
        public int Id { get; set; }
        public int ProjectId { get; set; }
        [Required] public DateTime ActivityDate { get; set; } = DateTime.UtcNow;
        [Required, MaxLength(500)] public string Summary { get; set; } = string.Empty;
        [MaxLength(5000)] public string? Description { get; set; }
        [MaxLength(1000)] public string? NextAction { get; set; }
        [MaxLength(100)] public string? ActivityType { get; set; }
        [MaxLength(200)] public string? PerformedBy { get; set; }
    }

    public void Dispose()
    {
        Localizer.OnLanguageChanged -= OnLanguageChanged;
    }

    private void OnLanguageChanged()
    {
        InvokeAsync(StateHasChanged);
    }
}

