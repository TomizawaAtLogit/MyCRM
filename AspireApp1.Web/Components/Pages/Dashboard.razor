@page "/dashboard"
@using AspireApp1.DbApi.DTOs
@using AspireApp1.Web
@using AspireApp1.FrontEnd.Services
@inject DashboardApiClient DashboardApi
@inject LocalizationService Localizer
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>@Localizer.GetString("Dashboard")</PageTitle>

<div class="container-fluid">
    <h2 class="mb-4">
        <i class="bi bi-bar-chart-fill"></i> @Localizer.GetString("Dashboard")
    </h2>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">@Localizer.GetString("Loading")...</span>
            </div>
            <p class="mt-3">@Localizer.GetString("Loading dashboard metrics")...</p>
        </div>
    }
    else if (metrics == null)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> @Localizer.GetString("No metrics available. Please configure your role coverage.")
        </div>
    }
    else
    {
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title">@Localizer.GetString("Total Cases")</h6>
                        <h2>@metrics.TotalCases</h2>
                        <small>@metrics.OpenCases @Localizer.GetString("open")</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">@Localizer.GetString("Resolution Rate")</h6>
                        <h2>@metrics.CaseResolutionRate.ToString("F1")%</h2>
                        <small>@metrics.ResolvedCases @Localizer.GetString("resolved")</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">@Localizer.GetString("SLA Compliance")</h6>
                        <h2>@metrics.SlaComplianceRate.ToString("F1")%</h2>
                        <small>@metrics.CasesResolvedWithinSla / @(metrics.CasesResolvedWithinSla + metrics.CasesResolvedOutsideSla)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h6 class="card-title">@Localizer.GetString("Active Projects")</h6>
                        <h2>@metrics.ActiveProjects</h2>
                        <small>@metrics.TotalProjects @Localizer.GetString("total")</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDCA Charts -->
        <div class="row mb-4">
            <!-- Plan Phase: Pre-sales -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">@Localizer.GetString("Plan") - @Localizer.GetString("Pre-sales Pipeline")</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="preSalesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Do Phase: Cases by Status -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">@Localizer.GetString("Do") - @Localizer.GetString("Case Status")</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="caseStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <!-- Check Phase: Case Priority -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">@Localizer.GetString("Check") - @Localizer.GetString("Case Priority")</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="casePriorityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Act Phase: Project Status -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">@Localizer.GetString("Act") - @Localizer.GetString("Project Status")</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="projectStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DashboardMetricDto? metrics;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Localizer.OnLanguageChanged += OnLanguageChanged;
        await LoadMetrics();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && metrics != null)
        {
            await RenderCharts();
        }
    }

    private async Task LoadMetrics()
    {
        try
        {
            isLoading = true;
            metrics = await DashboardApi.GetCurrentMetricsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard metrics: {ex.Message}");
            metrics = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RenderCharts()
    {
        if (metrics == null) return;

        try
        {
            // Pre-sales pipeline chart (Plan)
            var preSalesLabels = new[] 
            { 
                Localizer.GetString("Identification"),
                Localizer.GetString("Qualification"),
                Localizer.GetString("Proposal"),
                Localizer.GetString("Negotiation"),
                Localizer.GetString("Closed Won"),
                Localizer.GetString("Closed Lost")
            };
            var preSalesData = new[] 
            {
                metrics.PreSalesProposalsByStageIdentification,
                metrics.PreSalesProposalsByStageQualification,
                metrics.PreSalesProposalsByStageProposal,
                metrics.PreSalesProposalsByStageNegotiation,
                metrics.PreSalesProposalsByStageClosedWon,
                metrics.PreSalesProposalsByStageClosedLost
            };
            await JS.InvokeVoidAsync("DashboardCharts.createBarChart", "preSalesChart", preSalesLabels, preSalesData, Localizer.GetString("Pre-sales Pipeline by Stage"));

            // Case status chart (Do)
            var caseStatusLabels = new[] 
            { 
                Localizer.GetString("Open"),
                Localizer.GetString("In Progress"),
                Localizer.GetString("Resolved"),
                Localizer.GetString("Closed")
            };
            var caseStatusData = new[] 
            {
                metrics.OpenCases,
                metrics.InProgressCases,
                metrics.ResolvedCases,
                metrics.ClosedCases
            };
            await JS.InvokeVoidAsync("DashboardCharts.createPieChart", "caseStatusChart", caseStatusLabels, caseStatusData, Localizer.GetString("Cases by Status"));

            // Case priority chart (Check)
            var casePriorityLabels = new[] 
            { 
                Localizer.GetString("Critical"),
                Localizer.GetString("High"),
                Localizer.GetString("Medium"),
                Localizer.GetString("Low")
            };
            var casePriorityData = new[] 
            {
                metrics.CriticalPriorityCases,
                metrics.HighPriorityCases,
                metrics.MediumPriorityCases,
                metrics.LowPriorityCases
            };
            await JS.InvokeVoidAsync("DashboardCharts.createPieChart", "casePriorityChart", casePriorityLabels, casePriorityData, Localizer.GetString("Cases by Priority"));

            // Project status chart (Act)
            var projectStatusLabels = new[] 
            { 
                Localizer.GetString("Active"),
                Localizer.GetString("Completed"),
                Localizer.GetString("On Hold")
            };
            var projectStatusData = new[] 
            {
                metrics.ActiveProjects,
                metrics.CompletedProjects,
                metrics.OnHoldProjects
            };
            await JS.InvokeVoidAsync("DashboardCharts.createBarChart", "projectStatusChart", projectStatusLabels, projectStatusData, Localizer.GetString("Projects by Status"));
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering charts: {ex.Message}");
        }
    }

    private async void OnLanguageChanged()
    {
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await RenderCharts();
        });
    }

    public void Dispose()
    {
        Localizer.OnLanguageChanged -= OnLanguageChanged;
    }
}
